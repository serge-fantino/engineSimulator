(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(a){if(a.ep)return;a.ep=!0;const i=t(a);fetch(a.href,i)}})();function Z(p,e){if(e.length===0)return 0;if(p<=e[0][0])return e[0][1];if(p>=e[e.length-1][0])return e[e.length-1][1];for(let t=0;t<e.length-1;t++){const[s,a]=e[t],[i,r]=e[t+1];if(p>=s&&p<=i){const l=(p-s)/(i-s);return a+l*(r-a)}}return e[e.length-1][1]}function j(p,e,t){return Z(p,t.torqueCurve)*Math.pow(Math.max(0,e),1.5)}function F(p,e){const s=p*e*(2*Math.PI/60)/1e3;return{kw:s,hp:s*1.341}}function J(p,e){return Math.max(e.idleRPM,Math.min(p,e.redlineRPM))}const ee=15;function Y(p,e,t,s){if(p<e.redlineRPM-100)return{torqueMultiplier:1,newPhase:0,popTriggered:!1};const a=(t+s*ee)%1,i=a<.5,r=i&&t>=.5;return{torqueMultiplier:i?.05:.7,newPhase:a,popTriggered:r}}const V=2*Math.PI,A=800,te=120;class D{_gear=0;_isShifting=!1;shiftTimer=0;lastShiftTime=0;_mode="automatic";profile;manualOverrideUntil=0;static MANUAL_OVERRIDE_DURATION_MS=2500;constructor(e){this.profile=e}get gear(){return this._gear}get isShifting(){return this._isShifting}get maxGear(){return this.profile.gearRatios.length}get mode(){return this._mode}set mode(e){this._mode=e}setProfile(e){this.profile=e,this._gear=0,this._isShifting=!1,this.manualOverrideUntil=0}speedToRPM(e,t){if(t<1||t>this.maxGear)return this.profile.idleRPM;const s=this.profile.gearRatios[t-1];return e*s*this.profile.finalDrive*60/(V*this.profile.wheelRadius)}rpmToSpeed(e,t){if(t<1||t>this.maxGear)return 0;const s=this.profile.gearRatios[t-1];return e*V*this.profile.wheelRadius/(s*this.profile.finalDrive*60)}update(e){this._isShifting&&(this.shiftTimer-=e*1e3,this.shiftTimer<=0&&(this._isShifting=!1))}checkAutoShift(e,t,s){if(this._mode!=="automatic"||this._isShifting||this._gear===0||s<this.manualOverrideUntil||s-this.lastShiftTime<A)return;const a=this.profile.peakPowerRPM*(.6+.35*t),i=this.profile.peakTorqueRPM*(.4+.2*t);e>a&&this._gear<this.maxGear?this.doShift(this._gear+1,s):e<i&&this._gear>1&&this.doShift(this._gear-1,s)}shiftUp(e){this._isShifting||this._gear>=this.maxGear||e-this.lastShiftTime<A||this.doShift(this._gear+1,e)}shiftDown(e,t=0){this._isShifting||this._gear<=0||e-this.lastShiftTime<A||this._gear===1&&t>=1||this.doShift(this._gear-1,e)}manualOverrideShift(e,t){if(this._isShifting||t-this.lastShiftTime<A||this._gear===0)return;const s=e==="up"?Math.min(this._gear+1,this.maxGear):Math.max(this._gear-1,1);s!==this._gear&&(this.doShift(s,t),this.manualOverrideUntil=t+D.MANUAL_OVERRIDE_DURATION_MS)}doShift(e,t){this._isShifting=!0,this.shiftTimer=te,this.lastShiftTime=t,this._gear=e}reset(){this._gear=0,this._isShifting=!1,this.shiftTimer=0,this.lastShiftTime=0,this.manualOverrideUntil=0}}const ie=1.225,L=9.81,se=.85,ae=[0,.25,.15,.1,.08,.06,.05,.04,.035],oe=1.2;function ne(p){switch(p.driveType||"rwd"){case"awd":return .95;case"fwd":return .55;case"rwd":return .5;default:return .5}}class H{_speedMs=0;_accelerationMs2=0;_wheelSlip=0;profile;constructor(e){this.profile=e}get speedMs(){return this._speedMs}get accelerationMs2(){return this._accelerationMs2}get wheelSlip(){return this._wheelSlip}setProfile(e){this.profile=e}update(e,t,s,a,i){const r=this.profile;let l=0;if(!i&&s>=1&&s<=r.gearRatios.length){const P=r.gearRatios[s-1];l=t*P*r.finalDrive*se/r.wheelRadius}const c=ne(r),o=oe*r.vehicleMass*c*L;this._wheelSlip=0,l>o&&l>0&&(this._wheelSlip=Math.min(1,(l-o)/o),l=o*(1-.3*this._wheelSlip));const n=r.vehicleMass*L*.8,d=a*n,h=.5*r.dragCoefficient*ie*r.frontalArea*this._speedMs*this._speedMs,u=r.rollingResistance*r.vehicleMass*L,m=l-d-h-u,v=ae[s]??.05,f=r.vehicleMass*(1+v);return this._accelerationMs2=m/f,this._speedMs=Math.max(0,this._speedMs+this._accelerationMs2*e),{speedMs:this._speedMs,accelerationMs2:this._accelerationMs2,wheelSlip:this._wheelSlip}}reset(){this._speedMs=0,this._accelerationMs2=0,this._wheelSlip=0}}class I{boostActual=0;bovTriggered=!1;bovTime=0;prevThrottle=0;config;constructor(e){this.config=e}setConfig(e){this.config=e}update(e,t,s){const a=this.config;let i=0;if(e>=a.boostThresholdRPM){const o=Math.min(1,(e-a.boostThresholdRPM)/2e3);i=a.maxBoostBar*t*o}const r=a.spoolTimeSec*(a.boostThresholdRPM/Math.max(e,a.boostThresholdRPM)),l=Math.max(r,.01);this.boostActual+=(i-this.boostActual)*(s/l);let c=0;return a.hasBOV&&t<.1&&this.boostActual>.3&&this.prevThrottle>.3&&(this.bovTriggered=!0,this.bovTime=0,this.boostActual*=.5),this.bovTriggered&&(this.bovTime+=s,c=this.bovTime<.01?this.bovTime/.01:Math.exp(-(this.bovTime-.01)/.2),c<.01&&(this.bovTriggered=!1,c=0)),this.prevThrottle=t,{boostBar:Math.max(0,this.boostActual),bovActive:this.bovTriggered,bovEnvelope:c}}reset(){this.boostActual=0,this.bovTriggered=!1,this.bovTime=0,this.prevThrottle=0}}class re{lowpass;peakingFilters;_input;_output;get input(){return this._input}get output(){return this._output}constructor(e,t){this.lowpass=e.createBiquadFilter(),this.lowpass.type="lowpass",this.lowpass.frequency.value=t.lowpassBaseFreq,this.lowpass.Q.value=t.lowpassQ,this.peakingFilters=t.resonances.map(a=>{const i=e.createBiquadFilter();return i.type="peaking",i.frequency.value=a.freq,i.Q.value=a.Q,i.gain.value=a.gainDB,i});let s=this.lowpass;for(const a of this.peakingFilters)s.connect(a),s=a;this._input=this.lowpass,this._output=this.peakingFilters.length>0?this.peakingFilters[this.peakingFilters.length-1]:this.lowpass}update(e,t){const s=t.lowpassBaseFreq+e*t.lowpassRpmScale;this.lowpass.frequency.setTargetAtTime(s,0,.03)}disconnect(){this.lowpass.disconnect();for(const e of this.peakingFilters)e.disconnect()}}class le{turboOsc;turboOsc2;turboGain;turboBandpass;bovGain;bovBandpass;mixerGain;ctx;noiseBuffer;activeBovSource=null;get output(){return this.mixerGain}constructor(e,t){this.ctx=e,this.turboOsc=e.createOscillator(),this.turboOsc.type="sine",this.turboOsc.frequency.value=2e3,this.turboOsc2=e.createOscillator(),this.turboOsc2.type="sine",this.turboOsc2.frequency.value=4e3,this.turboBandpass=e.createBiquadFilter(),this.turboBandpass.type="bandpass",this.turboBandpass.frequency.value=3e3,this.turboBandpass.Q.value=4,this.turboGain=e.createGain(),this.turboGain.gain.value=0;const s=e.createGain();s.gain.value=.3,this.turboOsc.connect(this.turboBandpass),this.turboOsc2.connect(s),s.connect(this.turboBandpass),this.turboBandpass.connect(this.turboGain),this.bovBandpass=e.createBiquadFilter(),this.bovBandpass.type="bandpass",this.bovBandpass.frequency.value=1200,this.bovBandpass.Q.value=3,this.bovGain=e.createGain(),this.bovGain.gain.value=0,this.bovBandpass.connect(this.bovGain),this.mixerGain=e.createGain(),this.mixerGain.gain.value=1,this.turboGain.connect(this.mixerGain),this.bovGain.connect(this.mixerGain),this.noiseBuffer=this.createNoiseBuffer(.5),this.turboOsc.start(),this.turboOsc2.start()}update(e,t){const s=2e3+e*8e3,a=e*.12;this.turboOsc.frequency.setTargetAtTime(s,0,.05),this.turboOsc2.frequency.setTargetAtTime(s*2,0,.05),this.turboGain.gain.setTargetAtTime(a,0,.03),this.turboBandpass.frequency.setTargetAtTime(s,0,.05)}triggerBOV(e){if(e>.01&&!this.activeBovSource){const t=this.ctx.createBufferSource();t.buffer=this.noiseBuffer,t.connect(this.bovBandpass),t.start(),this.activeBovSource=t,t.onended=()=>{this.activeBovSource=null}}this.bovGain.gain.setTargetAtTime(e*.4,0,.01)}disconnect(){this.turboOsc.stop(),this.turboOsc2.stop(),this.turboGain.disconnect(),this.bovGain.disconnect(),this.mixerGain.disconnect()}createNoiseBuffer(e){const t=Math.floor(this.ctx.sampleRate*e),s=this.ctx.createBuffer(1,t,this.ctx.sampleRate),a=s.getChannelData(0);for(let i=0;i<t;i++)a[i]=Math.random()*2-1;return s}}class ce{ctx=null;workletNode=null;exhaustFilter=null;turboAudio=null;masterGain=null;compressor=null;profile=null;isRunning=!1;popNoiseBuffer=null;activePopSource=null;popGain=null;_crackleActive=!1;squealSource=null;squealGain=null;squealNoiseBuffer=null;async initialize(e){this.profile=e,this.ctx=new AudioContext({latencyHint:"interactive",sampleRate:44100});const t=new URL(""+new URL("engine-worklet-BQmEtZle.js",import.meta.url).href,import.meta.url);await this.ctx.audioWorklet.addModule(t.href),this.buildGraph(e)}buildGraph(e){const t=this.ctx;this.workletNode=new AudioWorkletNode(t,"engine-worklet",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[1]}),this.exhaustFilter=new re(t,e.exhaustConfig),e.turbo&&(this.turboAudio=new le(t,e.turbo)),this.compressor=t.createDynamicsCompressor(),this.compressor.threshold.value=-6,this.compressor.knee.value=3,this.compressor.ratio.value=12,this.compressor.attack.value=.003,this.compressor.release.value=.1,this.popGain=t.createGain(),this.popGain.gain.value=1,this.masterGain=t.createGain(),this.masterGain.gain.value=.7,this.workletNode.connect(this.exhaustFilter.input),this.exhaustFilter.output.connect(this.compressor),this.turboAudio&&this.turboAudio.output.connect(this.compressor),this.compressor.connect(this.masterGain),this.popGain.connect(this.masterGain),this.masterGain.connect(t.destination),this.setupTireSqueal()}start(){this.ctx&&this.ctx.state==="suspended"&&this.ctx.resume(),this.isRunning=!0}stop(){if(this.isRunning=!1,this.squealSource){try{this.squealSource.stop()}catch{}this.squealSource=null}this.ctx&&this.ctx.state==="running"&&this.ctx.suspend()}update(e){!this.workletNode||!this.profile||!this.isRunning||(this.workletNode.port.postMessage({type:"params",params:{rpm:e.rpm,throttle:e.throttle,cylinders:this.profile.cylinders,engineType:this.profile.type,spectralRolloff:this.profile.harmonicProfile.spectralRolloff,firingHarmonicBoost:this.profile.harmonicProfile.firingHarmonicBoost,numHarmonics:this.profile.harmonicProfile.numHarmonics,boostBar:e.boostBar,isShifting:e.isShifting}}),this.exhaustFilter?.update(e.rpm,this.profile.exhaustConfig),this.turboAudio&&this.turboAudio.update(e.boostBar,e.rpm))}triggerBOV(e){this.turboAudio?.triggerBOV(e)}triggerRevLimiterPop(){if(!this.ctx||!this.popGain)return;const e=this.ctx;if(!this.popNoiseBuffer){const l=Math.floor(e.sampleRate*.15);this.popNoiseBuffer=e.createBuffer(1,l,e.sampleRate);const c=this.popNoiseBuffer.getChannelData(0);for(let o=0;o<l;o++)c[o]=Math.random()*2-1}if(this.activePopSource)return;const t=e.createBufferSource();t.buffer=this.popNoiseBuffer;const s=e.createBiquadFilter();s.type="bandpass",s.frequency.value=600+Math.random()*600,s.Q.value=4;const a=e.createGain(),i=e.currentTime,r=.05+Math.random()*.05;a.gain.setValueAtTime(0,i),a.gain.linearRampToValueAtTime(.9,i+.005),a.gain.exponentialRampToValueAtTime(.01,i+r),t.connect(s),s.connect(a),a.connect(this.popGain),t.start(i),t.stop(i+.15),this.activePopSource=t,t.onended=()=>{this.activePopSource=null}}triggerDecelCrackle(){if(!this.ctx||!this.popGain||this._crackleActive)return;const e=this.ctx;if(this._crackleActive=!0,!this.popNoiseBuffer){const i=Math.floor(e.sampleRate*.15);this.popNoiseBuffer=e.createBuffer(1,i,e.sampleRate);const r=this.popNoiseBuffer.getChannelData(0);for(let l=0;l<i;l++)r[l]=Math.random()*2-1}const t=3+Math.floor(Math.random()*5);let s=0;const a=e.currentTime;for(let i=0;i<t;i++){const r=.03+Math.random()*.05;s+=r;const l=e.createBufferSource();l.buffer=this.popNoiseBuffer;const c=e.createBiquadFilter();c.type="bandpass",c.frequency.value=600+Math.random()*900,c.Q.value=3+Math.random()*2;const o=e.createGain(),n=(.6-i*.06)*(.5+Math.random()*.5),d=a+s;o.gain.setValueAtTime(0,d),o.gain.linearRampToValueAtTime(Math.max(.1,n),d+.003),o.gain.exponentialRampToValueAtTime(.01,d+.04),l.connect(c),c.connect(o),o.connect(this.popGain),l.start(d),l.stop(d+.06)}setTimeout(()=>{this._crackleActive=!1},(s+.1)*1e3)}setupTireSqueal(){if(!this.ctx||!this.masterGain)return;const e=this.ctx,t=Math.floor(e.sampleRate*2);this.squealNoiseBuffer=e.createBuffer(1,t,e.sampleRate);const s=this.squealNoiseBuffer.getChannelData(0);for(let r=0;r<t;r++)s[r]=Math.random()*2-1;const a=e.createBufferSource();a.buffer=this.squealNoiseBuffer,a.loop=!0;const i=e.createBiquadFilter();i.type="bandpass",i.frequency.value=3e3,i.Q.value=3,this.squealGain=e.createGain(),this.squealGain.gain.value=0,a.connect(i),i.connect(this.squealGain),this.squealGain.connect(this.masterGain),a.start(),this.squealSource=a}updateTireSqueal(e){if(!this.squealGain||!this.ctx)return;const t=e>.1?Math.min(.5,e*.8):0;this.squealGain.gain.setTargetAtTime(t,this.ctx.currentTime,.05)}async playStarterSound(){if(!this.ctx)return;const e=this.ctx,t=e.currentTime,s=.5,a=Math.floor(e.sampleRate*s),i=e.createBuffer(1,a,e.sampleRate),r=i.getChannelData(0);for(let n=0;n<a;n++)r[n]=Math.random()*2-1;const l=e.createBufferSource();l.buffer=i;const c=e.createBiquadFilter();c.type="bandpass",c.Q.value=5,c.frequency.setValueAtTime(100,t),c.frequency.linearRampToValueAtTime(500,t+.4);const o=e.createGain();return o.gain.setValueAtTime(0,t),o.gain.linearRampToValueAtTime(.3,t+.05),o.gain.setValueAtTime(.3,t+.35),o.gain.linearRampToValueAtTime(0,t+.45),l.connect(c),c.connect(o),o.connect(this.compressor||e.destination),l.start(t),l.stop(t+s),new Promise(n=>setTimeout(n,500))}setVolume(e){this.masterGain&&this.masterGain.gain.setTargetAtTime(Math.max(0,Math.min(1,e)),0,.05)}async switchProfile(e){if(this.ctx){if(this.masterGain&&this.masterGain.gain.setTargetAtTime(0,this.ctx.currentTime,.15),await new Promise(t=>setTimeout(t,300)),this.squealSource){try{this.squealSource.stop()}catch{}this.squealSource=null}this.workletNode?.disconnect(),this.exhaustFilter?.disconnect(),this.turboAudio?.disconnect(),this.compressor?.disconnect(),this.popGain?.disconnect(),this.masterGain?.disconnect(),this.turboAudio=null,this.profile=e,this.buildGraph(e),this.masterGain&&(this.masterGain.gain.value=0,this.masterGain.gain.setTargetAtTime(.7,this.ctx.currentTime,.15))}}}class G{canvas;ctx2d;data=[];timer=0;isRecording=!1;milestones=[];maxSpeedKmh;maxTime=10;static SPEED_THRESHOLDS=[100,200];constructor(e,t){this.maxSpeedKmh=this.calculateDisplayMax(t),this.canvas=document.createElement("canvas"),this.canvas.id="perf-graph-canvas",this.ctx2d=this.canvas.getContext("2d"),document.getElementById(e).appendChild(this.canvas),this.setupResize(),this.resizeCanvas()}setProfile(e){this.maxSpeedKmh=this.calculateDisplayMax(e),this.reset()}reset(){this.data=[],this.milestones=[],this.timer=0,this.isRecording=!1}update(e){if(this.isRecording||e.gear>=1&&e.throttle>.1&&e.speedKmh<5&&(this.isRecording=!0,this.data=[],this.milestones=[],this.timer=0),!this.isRecording){this.draw();return}if(e.brake>.3||e.gear===0){this.isRecording=!1,this.draw();return}this.timer+=1/60,this.data.push({time:this.timer,speedKmh:e.speedKmh});for(const t of G.SPEED_THRESHOLDS)!this.milestones.find(s=>s.speedKmh===t)&&e.speedKmh>=t&&this.milestones.push({speedKmh:t,time:this.timer});this.timer>this.maxTime-1&&(this.maxTime=Math.ceil(this.timer+5)),this.data.length>1200&&(this.data=this.data.filter((t,s)=>s%2===0)),this.draw()}draw(){const e=this.ctx2d,t=this.canvas.width/(window.devicePixelRatio||1),s=this.canvas.height/(window.devicePixelRatio||1),a=window.devicePixelRatio||1;e.setTransform(a,0,0,a,0,0),e.clearRect(0,0,t,s);const i={top:10,right:12,bottom:22,left:40},r=t-i.left-i.right,l=s-i.top-i.bottom;if(r<20||l<20)return;e.fillStyle="rgba(15, 21, 41, 0.6)",e.strokeStyle="#2a2a4a",e.lineWidth=1,e.beginPath(),e.roundRect(0,0,t,s,6),e.fill(),e.stroke(),e.font="9px system-ui",e.textAlign="right",e.textBaseline="middle";const c=this.maxSpeedKmh>200?100:50;for(let n=0;n<=this.maxSpeedKmh;n+=c){const d=i.top+l-n/this.maxSpeedKmh*l;e.strokeStyle="#1e293b",e.beginPath(),e.moveTo(i.left,d),e.lineTo(i.left+r,d),e.stroke(),e.fillStyle="#556",e.fillText(String(n),i.left-4,d)}for(const n of G.SPEED_THRESHOLDS){if(n>this.maxSpeedKmh)continue;const d=i.top+l-n/this.maxSpeedKmh*l;e.strokeStyle=n===100?"rgba(234, 179, 8, 0.4)":"rgba(233, 69, 96, 0.4)",e.setLineDash([4,4]),e.beginPath(),e.moveTo(i.left,d),e.lineTo(i.left+r,d),e.stroke(),e.setLineDash([])}e.textAlign="center",e.textBaseline="top";const o=this.maxTime<=10?2:5;for(let n=0;n<=this.maxTime;n+=o){const d=i.left+n/this.maxTime*r;e.fillStyle="#556",e.fillText(`${n}s`,d,i.top+l+4)}if(this.data.length>1){e.beginPath(),e.strokeStyle="#22c55e",e.lineWidth=2,e.lineJoin="round";for(let n=0;n<this.data.length;n++){const d=this.data[n],h=i.left+d.time/this.maxTime*r,u=i.top+l-d.speedKmh/this.maxSpeedKmh*l;n===0?e.moveTo(h,u):e.lineTo(h,u)}e.stroke()}for(const n of this.milestones){const d=i.left+n.time/this.maxTime*r,h=i.top+l-n.speedKmh/this.maxSpeedKmh*l;e.beginPath(),e.arc(d,h,4,0,Math.PI*2),e.fillStyle=n.speedKmh===100?"#eab308":"#e94560",e.fill();const u=`0-${n.speedKmh}: ${n.time.toFixed(1)}s`;e.font="bold 10px system-ui";const v=e.measureText(u).width+10,f=16,P=Math.min(d+6,i.left+r-v),R=h-f-4;e.fillStyle=n.speedKmh===100?"rgba(234, 179, 8, 0.85)":"rgba(233, 69, 96, 0.85)",e.beginPath(),e.roundRect(P,R,v,f,3),e.fill(),e.fillStyle="#fff",e.textAlign="left",e.textBaseline="middle",e.fillText(u,P+5,R+f/2)}this.isRecording&&(e.fillStyle="#e94560",e.beginPath(),e.arc(t-16,14,4,0,Math.PI*2),e.fill(),e.fillStyle="#889",e.font="9px system-ui",e.textAlign="right",e.textBaseline="middle",e.fillText("REC",t-24,14))}calculateDisplayMax(e){const t=e.peakPower*1e3,s=1.225;let a=0,i=200;for(let l=0;l<50;l++){const c=(a+i)/2,o=.5*e.dragCoefficient*s*e.frontalArea*c*c*c,n=e.rollingResistance*e.vehicleMass*9.81*c;o+n<t*.85?a=c:i=c}const r=(a+i)/2*3.6;return Math.ceil(r/50)*50}setupResize(){new ResizeObserver(()=>this.resizeCanvas()).observe(this.canvas.parentElement)}resizeCanvas(){const t=this.canvas.parentElement.getBoundingClientRect(),s=window.devicePixelRatio||1,a=Math.min(t.width,600),i=120;this.canvas.width=a*s,this.canvas.height=i*s,this.canvas.style.width=`${a}px`,this.canvas.style.height=`${i}px`,this.draw()}}class he{canvas;ctx2d;gaugesEl;profile;logicalW=600;logicalH=500;lastState=null;speedVal;accelVal;powerVal;torqueVal;boostVal;boostCard;speedBarFill;speedBarValue;speedBarMax;maxSpeedKmh;perfGraph;constructor(e,t,s){this.canvas=document.getElementById(e),this.ctx2d=this.canvas.getContext("2d"),this.gaugesEl=document.getElementById(t),this.profile=s,this.maxSpeedKmh=this.calculateMaxSpeed(s),this.buildSpeedBar(),this.buildGauges(),this.setupResize(),this.resizeCanvas(),this.perfGraph=new G("dashboard-container",s),this.drawTachometer(0,0,!1,!1)}setProfile(e){this.profile=e,this.boostCard.style.display=e.turbo?"":"none",this.maxSpeedKmh=this.calculateMaxSpeed(e),this.speedBarMax.textContent=Math.round(this.maxSpeedKmh).toString(),this.perfGraph.setProfile(e),this.lastState=null,this.drawTachometer(0,0,!1,!1)}render(e){this.lastState=e,this.drawTachometer(e.rpm,e.gear,e.isShifting,e.revLimiterActive),this.updateGauges(e),this.updateSpeedBar(e.speedKmh),this.perfGraph.update(e)}calculateMaxSpeed(e){const t=e.peakPower*1e3,s=1.225,a=e.dragCoefficient,i=e.frontalArea,r=e.rollingResistance,l=e.vehicleMass,c=9.81,o=.85;let n=0,d=200;for(let v=0;v<50;v++){const f=(n+d)/2,P=.5*a*s*i*f*f*f,R=r*l*c*f;P+R<t*o?n=f:d=f}const h=(n+d)/2,u=e.gearRatios[e.gearRatios.length-1],m=e.redlineRPM*2*Math.PI*e.wheelRadius/(u*e.finalDrive*60);return Math.min(h,m)*3.6}buildSpeedBar(){const e=this.canvas.parentElement,t=document.createElement("div");t.id="tacho-area";const s=document.createElement("div");s.className="speed-bar-container",s.innerHTML=`
      <div class="speed-bar-max" id="speed-bar-max">${Math.round(this.maxSpeedKmh)}</div>
      <div class="speed-bar-track">
        <div class="speed-bar-fill" id="speed-bar-fill"></div>
      </div>
      <div class="speed-bar-value" id="speed-bar-value">0</div>
      <div class="speed-bar-unit">km/h</div>
    `,e.insertBefore(t,this.canvas),t.appendChild(s),t.appendChild(this.canvas),this.speedBarFill=document.getElementById("speed-bar-fill"),this.speedBarValue=document.getElementById("speed-bar-value"),this.speedBarMax=document.getElementById("speed-bar-max")}updateSpeedBar(e){const t=Math.min(100,e/this.maxSpeedKmh*100);this.speedBarFill.style.height=`${t}%`,this.speedBarValue.textContent=e.toFixed(0)}buildGauges(){this.gaugesEl.innerHTML="";const e=[{id:"speed",label:"Vitesse",unit:"km/h"},{id:"accel",label:"Accélération",unit:"G"},{id:"power",label:"Puissance",unit:"ch"},{id:"torque",label:"Couple",unit:"Nm"},{id:"boost",label:"Boost",unit:"bar"}];for(const t of e){const s=document.createElement("div");s.className="gauge-card",s.id=`gauge-${t.id}`,s.innerHTML=`
        <div class="gauge-label">${t.label}</div>
        <div>
          <span class="gauge-value" id="val-${t.id}">0</span>
          <span class="gauge-unit">${t.unit}</span>
        </div>
      `,this.gaugesEl.appendChild(s)}this.speedVal=document.getElementById("val-speed"),this.accelVal=document.getElementById("val-accel"),this.powerVal=document.getElementById("val-power"),this.torqueVal=document.getElementById("val-torque"),this.boostVal=document.getElementById("val-boost"),this.boostCard=document.getElementById("gauge-boost"),this.boostCard.style.display=this.profile.turbo?"":"none"}updateGauges(e){this.speedVal.textContent=e.speedKmh.toFixed(0),this.accelVal.textContent=e.accelerationG.toFixed(2),this.powerVal.textContent=e.powerHp.toFixed(0),this.torqueVal.textContent=e.torqueNm.toFixed(0),this.profile.turbo&&(this.boostVal.textContent=e.boostBar.toFixed(2))}drawTachometer(e,t,s,a){const i=this.ctx2d,r=this.logicalW,l=this.logicalH,c=r/2,o=l*.52,n=Math.min(r,l)*.36,d=window.devicePixelRatio||1;i.setTransform(d,0,0,d,0,0),i.clearRect(0,0,r,l);const h=5/4*Math.PI,u=-1/4*Math.PI,m=3/2*Math.PI,v=Math.ceil(this.profile.redlineRPM/1e3)*1e3,f=this.profile.redlineRPM;i.beginPath(),i.arc(c,o,n,h,u,!1),i.lineWidth=18,i.strokeStyle="#1e293b",i.stroke();const P=h+f/v*m;i.beginPath(),i.arc(c,o,n,P,u,!1),i.lineWidth=18,i.strokeStyle="rgba(233, 69, 96, 0.3)",i.stroke();const R=Math.min(e,v)/v,b=h+R*m,k=e>=f?"#e94560":"#22c55e";i.beginPath(),i.arc(c,o,n,h,b,!1),i.lineWidth=18,i.strokeStyle=k,i.lineCap="round",i.stroke(),i.lineCap="butt";const S=Math.max(11,n*.1);i.font=`${S}px system-ui`,i.textAlign="center",i.textBaseline="middle";for(let g=0;g<=v;g+=1e3){const x=h+g/v*m,T=Math.cos(x),y=Math.sin(x),$=n-12,_=n+12;i.beginPath(),i.moveTo(c+$*T,o+$*y),i.lineTo(c+_*T,o+_*y),i.lineWidth=2,i.strokeStyle=g>=f?"#e94560":"#556",i.stroke();const q=n+24;i.fillStyle=g>=f?"#e94560":"#889",i.fillText(String(g/1e3),c+q*T,o+q*y)}for(let g=500;g<v;g+=1e3){const x=h+g/v*m,T=Math.cos(x),y=Math.sin(x);i.beginPath(),i.moveTo(c+(n-6)*T,o+(n-6)*y),i.lineTo(c+(n+6)*T,o+(n+6)*y),i.lineWidth=1,i.strokeStyle="#334",i.stroke()}const B=h+Math.min(e,v)/v*m,C=n-22;i.save(),i.shadowColor=k,i.shadowBlur=8,i.beginPath(),i.moveTo(c,o),i.lineTo(c+C*Math.cos(B),o+C*Math.sin(B)),i.lineWidth=3,i.strokeStyle=k,i.stroke(),i.restore(),i.beginPath(),i.arc(c,o,6,0,Math.PI*2),i.fillStyle="#445",i.fill(),i.fillStyle=a?"#e94560":"#eee",i.font=`bold ${Math.max(20,n*.22)}px system-ui`,i.textAlign="center",i.fillText(Math.round(e).toString(),c,o+n*.32),i.font=`${Math.max(10,n*.08)}px system-ui`,i.fillStyle="#667",i.fillText("RPM",c,o+n*.44);const M=t===0?"N":String(t);if(i.font=`bold ${Math.max(24,n*.2)}px system-ui`,i.fillStyle=s?"#eab308":"#22c55e",i.fillText(M,c,o-n*.12),this.lastState&&(this.lastState.launchControlActive&&Math.sin(Date.now()*.01)>0&&(i.fillStyle="#eab308",i.font=`bold ${Math.max(10,n*.09)}px system-ui`,i.textAlign="center",i.fillText("LC",c,o+n*.58)),this.lastState.wheelSlip>.01)){const g=n*1.2,x=6,T=c-g/2,y=o+n*.68;i.fillStyle="#1e293b",i.beginPath(),i.roundRect(T,y,g,x,3),i.fill();const $=Math.min(1,this.lastState.wheelSlip),_=g*$,q=$<.3?"#22c55e":$<.6?"#eab308":"#e94560";i.fillStyle=q,i.beginPath(),i.roundRect(T,y,_,x,3),i.fill(),i.fillStyle="#889",i.font=`${Math.max(8,n*.06)}px system-ui`,i.textAlign="center",i.fillText(`SLIP ${Math.round($*100)}%`,c,y+x+10)}}setupResize(){new ResizeObserver(()=>this.resizeCanvas()).observe(this.canvas.parentElement)}resizeCanvas(){const t=this.canvas.parentElement.getBoundingClientRect(),s=window.devicePixelRatio||1,a=Math.min(t.width-50,600),i=Math.max(180,a*.75);this.logicalW=a,this.logicalH=i,this.canvas.width=a*s,this.canvas.height=i*s,this.canvas.style.width=`${a}px`,this.canvas.style.height=`${i}px`,this.lastState&&this.render(this.lastState)}}class de{throttle=0;brake=0;keysDown=new Set;_shiftUpPressed=!1;_shiftDownPressed=!1;_transmissionMode="automatic";container;throttleSlider;brakeSlider;throttleValEl;brakeValEl;gearNumberEl;autoBtn;manualBtn;powerBtn;volumeCallback=null;powerCallback=null;inputModeCallback=null;_isEngineOn=!1;_inputMode="keyboard";evBtn;keyboardBtn;evStatusEl;constructor(e){this.container=document.getElementById(e),this.buildUI(),this.setupKeyboard()}get transmissionMode(){return this._transmissionMode}onVolumeChange(e){this.volumeCallback=e}onPowerChange(e){this.powerCallback=e}onInputModeChange(e){this.inputModeCallback=e}get inputMode(){return this._inputMode}setEvStatus(e){if(this.evStatusEl)switch(e.state){case"inactive":this.evStatusEl.innerHTML="";break;case"requesting":this.evStatusEl.innerHTML='<span class="ev-status-dot requesting"></span>En attente GPS...';break;case"active":this.evStatusEl.innerHTML=`<span class="ev-status-dot active"></span>GPS actif (${Math.round(e.accuracy)}m)`;break;case"error":{const t={"permission-denied":"Permission refusée",unavailable:"GPS indisponible",timeout:"Timeout GPS","insecure-context":"HTTPS requis"};this.evStatusEl.innerHTML=`<span class="ev-status-dot error"></span>${t[e.reason]}`;break}}}revertToKeyboard(){this._inputMode="keyboard",this.keyboardBtn.classList.add("active"),this.evBtn.classList.remove("active"),this.container.classList.remove("ev-active"),this.setEvStatus({state:"inactive"})}simulatePowerOn(){this._isEngineOn||(this._isEngineOn=!0,this.powerBtn.classList.add("on"),this.powerCallback?.(!0))}updateGearDisplay(e,t){const s=e===0?"N":String(e);this.gearNumberEl.textContent=s,this.gearNumberEl.className=t?"gear-number shifting":"gear-number"}update(e){this.keysDown.has("w")||this.keysDown.has("arrowup")?this.throttle=Math.min(1,this.throttle+3*e):this.throttle=Math.max(0,this.throttle-5*e),this.keysDown.has("s")||this.keysDown.has("arrowdown")?this.brake=Math.min(1,this.brake+3*e):this.brake=Math.max(0,this.brake-5*e);const a=parseFloat(this.throttleSlider.value)/100,i=parseFloat(this.brakeSlider.value)/100,r=Math.max(this.throttle,a),l=Math.max(this.brake,i);this.throttleValEl.textContent=`${Math.round(r*100)}%`,this.brakeValEl.textContent=`${Math.round(l*100)}%`;const c={throttle:r,brake:l,shiftUpPressed:this._shiftUpPressed,shiftDownPressed:this._shiftDownPressed,transmissionMode:this._transmissionMode};return this._shiftUpPressed=!1,this._shiftDownPressed=!1,c}buildUI(){this.container.innerHTML=`
      <div class="control-section power-section">
        <button class="power-btn" id="power-btn" title="Démarrer / Arrêter le moteur">
          <span class="power-icon">⏻</span>
        </button>
      </div>

      <div class="control-section ev-section">
        <div class="control-label">Mode</div>
        <div class="mode-toggle ev-mode-toggle">
          <button id="mode-keyboard" class="active">Clavier</button>
          <button id="mode-ev">EV+</button>
        </div>
        <div class="ev-status" id="ev-status"></div>
      </div>

      <div class="control-section">
        <div class="control-label">Pédales</div>
        <div class="pedal-container">
          <div class="pedal-wrapper">
            <span class="pedal-value" id="throttle-val">0%</span>
            <input type="range" min="0" max="100" value="0"
                   class="pedal-slider throttle" id="throttle-slider" orient="vertical">
            <span class="pedal-name">Gaz</span>
          </div>
          <div class="pedal-wrapper">
            <span class="pedal-value" id="brake-val">0%</span>
            <input type="range" min="0" max="100" value="0"
                   class="pedal-slider brake" id="brake-slider" orient="vertical">
            <span class="pedal-name">Frein</span>
          </div>
        </div>
      </div>

      <div class="control-section">
        <div class="control-label">Rapport</div>
        <div class="gear-display">
          <button class="gear-btn" id="gear-down">◀</button>
          <span class="gear-number" id="gear-number">N</span>
          <button class="gear-btn" id="gear-up">▶</button>
        </div>
      </div>

      <div class="control-section">
        <div class="control-label">Transmission</div>
        <div class="mode-toggle">
          <button id="mode-auto" class="active">Auto</button>
          <button id="mode-manual">Manuel</button>
        </div>
      </div>

      <div class="control-section">
        <div class="control-label">Volume</div>
        <input type="range" min="0" max="100" value="70"
               class="volume-slider" id="volume-slider">
      </div>

      <div class="control-section key-hints-compact">
        <span><kbd>W</kbd>/<kbd>S</kbd> Gaz/Frein</span>
        <span><kbd>A</kbd>/<kbd>D</kbd> Rapports</span>
      </div>
    `,this.powerBtn=document.getElementById("power-btn"),this.powerBtn.addEventListener("click",()=>{this._isEngineOn=!this._isEngineOn,this.powerBtn.classList.toggle("on",this._isEngineOn),this.powerCallback?.(this._isEngineOn)}),this.keyboardBtn=document.getElementById("mode-keyboard"),this.evBtn=document.getElementById("mode-ev"),this.evStatusEl=document.getElementById("ev-status"),this.keyboardBtn.addEventListener("click",()=>{this._inputMode!=="keyboard"&&(this._inputMode="keyboard",this.keyboardBtn.classList.add("active"),this.evBtn.classList.remove("active"),this.container.classList.remove("ev-active"),this.inputModeCallback?.("keyboard"))}),this.evBtn.addEventListener("click",()=>{this._inputMode!=="ev-augmented"&&(this._inputMode="ev-augmented",this.evBtn.classList.add("active"),this.keyboardBtn.classList.remove("active"),this.container.classList.add("ev-active"),this.inputModeCallback?.("ev-augmented"))}),this.throttleSlider=document.getElementById("throttle-slider"),this.brakeSlider=document.getElementById("brake-slider"),this.throttleValEl=document.getElementById("throttle-val"),this.brakeValEl=document.getElementById("brake-val"),this.gearNumberEl=document.getElementById("gear-number"),this.autoBtn=document.getElementById("mode-auto"),this.manualBtn=document.getElementById("mode-manual"),document.getElementById("gear-down").addEventListener("click",()=>{this._shiftDownPressed=!0}),document.getElementById("gear-up").addEventListener("click",()=>{this._shiftUpPressed=!0}),this.autoBtn.addEventListener("click",()=>{this._transmissionMode="automatic",this.autoBtn.classList.add("active"),this.manualBtn.classList.remove("active")}),this.manualBtn.addEventListener("click",()=>{this._transmissionMode="manual",this.manualBtn.classList.add("active"),this.autoBtn.classList.remove("active")});const e=document.getElementById("volume-slider");e.addEventListener("input",()=>{this.volumeCallback?.(parseFloat(e.value)/100)})}setupKeyboard(){window.addEventListener("keydown",e=>{const t=e.key.toLowerCase();this.keysDown.add(t),(t==="a"||t==="arrowleft")&&(this._shiftDownPressed=!0),(t==="d"||t==="arrowright")&&(this._shiftUpPressed=!0)}),window.addEventListener("keyup",e=>{this.keysDown.delete(e.key.toLowerCase())})}}const pe=2*Math.PI;function N(p,e,t){const s=p.gearRatios[t];return e*pe*p.wheelRadius/(s*p.finalDrive*60)*3.6}function U(p){return p.torqueCurve.map(([e,t])=>({rpm:e,kw:F(t,e).kw}))}function K(p){return p.torqueCurve.map(([e,t])=>({rpm:e,nm:t}))}function ue(p){const e=Math.max(100,Math.floor((p.redlineRPM-p.idleRPM)/50)),t=[];for(let s=0;s<p.gearRatios.length;s++){const a=[];for(let i=p.idleRPM;i<=p.redlineRPM;i+=e)a.push({rpm:i,kmh:N(p,i,s)});a.length>0&&a[a.length-1].rpm<p.redlineRPM&&a.push({rpm:p.redlineRPM,kmh:N(p,p.redlineRPM,s)}),t.push({gear:s+1,points:a})}return t}const w={power:"#22c55e",torque:"#e94560",grid:"#1e293b",text:"#556",bg:"rgba(15, 21, 41, 0.6)",stroke:"#2a2a4a"},E=["#22c55e","#3b82f6","#eab308","#e94560","#a855f7","#06b6d4","#f97316","#ec4899"],O=["power","torque","power-torque","speed-gears"],Q={power:"Puissance",torque:"Couple","power-torque":"P + C","speed-gears":"Vitesse / rapports"};class me{profile;kind="power";canvas;ctx;resizeObserver=null;labelEl;constructor(e,t,s){this.profile=t,this.labelEl=s??null,this.labelEl&&(this.labelEl.textContent=Q[this.kind]),this.canvas=document.createElement("canvas"),this.canvas.className="detail-chart-canvas",this.canvas.title="Cliquer pour changer de courbe",this.ctx=this.canvas.getContext("2d"),this.canvas.addEventListener("click",()=>{const a=O.indexOf(this.kind),i=O[(a+1)%O.length];this.setChartKind(i)}),e.appendChild(this.canvas),this.resizeObserver=new ResizeObserver(()=>this.resizeAndDraw()),this.resizeObserver.observe(this.canvas.parentElement),this.resizeAndDraw()}setProfile(e){this.profile=e,this.resizeAndDraw()}setChartKind(e){this.kind!==e&&(this.kind=e,this.labelEl&&(this.labelEl.textContent=Q[e]),this.draw())}destroy(){this.resizeObserver?.disconnect(),this.canvas.remove()}resizeAndDraw(){const e=this.canvas.parentElement.getBoundingClientRect(),t=Math.max(200,Math.min(e.width,500)),s=88,a=window.devicePixelRatio||1;this.canvas.width=t*a,this.canvas.height=s*a,this.canvas.style.width=`${t}px`,this.canvas.style.height=`${s}px`,this.draw()}draw(){const e=this.ctx,t=this.canvas.width/(window.devicePixelRatio||1),s=this.canvas.height/(window.devicePixelRatio||1),a=window.devicePixelRatio||1;e.setTransform(a,0,0,a,0,0),e.clearRect(0,0,t,s);const i={top:8,right:8,bottom:20,left:36},r=t-i.left-i.right,l=s-i.top-i.bottom;if(r<10||l<10)return;e.fillStyle=w.bg,e.strokeStyle=w.stroke,e.lineWidth=1,e.beginPath(),e.roundRect(0,0,t,s,6),e.fill(),e.stroke();const{idleRPM:c,redlineRPM:o}=this.profile,n=c,d=o,h=d-n,u=v=>i.left+(v-n)/h*r;e.font="9px system-ui",e.textAlign="center",e.textBaseline="top";const m=h<=4e3?1e3:2e3;for(let v=Math.ceil(n/m)*m;v<=d;v+=m){const f=u(v);e.strokeStyle=w.grid,e.beginPath(),e.moveTo(f,i.top),e.lineTo(f,i.top+l),e.stroke(),e.fillStyle=w.text,e.fillText(`${v/1e3}k`,f,i.top+l+3)}this.kind==="power"?this.drawPowerCurve(i,r,l,u):this.kind==="torque"?this.drawTorqueCurve(i,r,l,u):this.kind==="power-torque"?this.drawPowerTorqueCurve(i,r,l,u):this.drawSpeedGearCurves(i,r,l,u)}drawPowerCurve(e,t,s,a){const i=U(this.profile);if(i.length<2)return;const r=Math.max(...i.map(o=>o.kw),this.profile.peakPower*1.05),l=o=>e.top+s-o/r*s;this.ctx.textAlign="right",this.ctx.textBaseline="middle";const c=r<=150?50:100;for(let o=0;o<=r;o+=c){const n=l(o);this.ctx.strokeStyle=w.grid,this.ctx.beginPath(),this.ctx.moveTo(e.left,n),this.ctx.lineTo(e.left+t,n),this.ctx.stroke(),this.ctx.fillStyle=w.text,this.ctx.fillText(String(o),e.left-4,n)}this.ctx.beginPath(),this.ctx.strokeStyle=w.power,this.ctx.lineWidth=2,this.ctx.lineJoin="round",i.forEach((o,n)=>{n===0?this.ctx.moveTo(a(o.rpm),l(o.kw)):this.ctx.lineTo(a(o.rpm),l(o.kw))}),this.ctx.stroke(),this.ctx.fillStyle=w.text,this.ctx.textAlign="left",this.ctx.fillText("kW",e.left+t+2,e.top+8)}drawTorqueCurve(e,t,s,a){const i=K(this.profile);if(i.length<2)return;const r=Math.max(...i.map(o=>o.nm),this.profile.peakTorque*1.05),l=o=>e.top+s-o/r*s;this.ctx.textAlign="right",this.ctx.textBaseline="middle";const c=r<=300?100:150;for(let o=0;o<=r;o+=c){const n=l(o);this.ctx.strokeStyle=w.grid,this.ctx.beginPath(),this.ctx.moveTo(e.left,n),this.ctx.lineTo(e.left+t,n),this.ctx.stroke(),this.ctx.fillStyle=w.text,this.ctx.fillText(String(o),e.left-4,n)}this.ctx.beginPath(),this.ctx.strokeStyle=w.torque,this.ctx.lineWidth=2,this.ctx.lineJoin="round",i.forEach((o,n)=>{n===0?this.ctx.moveTo(a(o.rpm),l(o.nm)):this.ctx.lineTo(a(o.rpm),l(o.nm))}),this.ctx.stroke(),this.ctx.fillStyle=w.text,this.ctx.textAlign="left",this.ctx.fillText("Nm",e.left+t+2,e.top+8)}drawPowerTorqueCurve(e,t,s,a){const i=U(this.profile),r=K(this.profile);if(i.length<2||r.length<2)return;const l=Math.max(...i.map(h=>h.kw),this.profile.peakPower*1.05),c=Math.max(...r.map(h=>h.nm),this.profile.peakTorque*1.05),o=h=>e.top+s-h/l*s,n=h=>e.top+s-h/c*s;this.ctx.textAlign="right",this.ctx.textBaseline="middle";const d=l<=150?50:100;for(let h=0;h<=l;h+=d){const u=o(h);this.ctx.strokeStyle=w.grid,this.ctx.beginPath(),this.ctx.moveTo(e.left,u),this.ctx.lineTo(e.left+t,u),this.ctx.stroke(),this.ctx.fillStyle=w.text,this.ctx.fillText(String(h),e.left-4,u)}this.ctx.beginPath(),this.ctx.strokeStyle=w.power,this.ctx.lineWidth=2,this.ctx.lineJoin="round",i.forEach((h,u)=>{u===0?this.ctx.moveTo(a(h.rpm),o(h.kw)):this.ctx.lineTo(a(h.rpm),o(h.kw))}),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle=w.torque,this.ctx.setLineDash([4,3]),r.forEach((h,u)=>{u===0?this.ctx.moveTo(a(h.rpm),n(h.nm)):this.ctx.lineTo(a(h.rpm),n(h.nm))}),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.font="9px system-ui",this.ctx.fillStyle=w.power,this.ctx.textAlign="left",this.ctx.fillText("kW",e.left+t+2,e.top+6),this.ctx.fillStyle=w.torque,this.ctx.fillText("Nm",e.left+t+2,e.top+16)}drawSpeedGearCurves(e,t,s,a){const i=ue(this.profile);let r=0;i.forEach(o=>{o.points.forEach(n=>{n.kmh>r&&(r=n.kmh)})}),r=Math.ceil(r/20)*20||100;const l=o=>e.top+s-o/r*s;this.ctx.textAlign="right",this.ctx.textBaseline="middle";const c=r<=150?50:100;for(let o=0;o<=r;o+=c){const n=l(o);this.ctx.strokeStyle=w.grid,this.ctx.beginPath(),this.ctx.moveTo(e.left,n),this.ctx.lineTo(e.left+t,n),this.ctx.stroke(),this.ctx.fillStyle=w.text,this.ctx.fillText(String(o),e.left-4,n)}i.forEach(({points:o},n)=>{const d=E[n%E.length];this.ctx.beginPath(),this.ctx.strokeStyle=d,this.ctx.lineWidth=1.5,this.ctx.lineJoin="round",o.forEach((h,u)=>{u===0?this.ctx.moveTo(a(h.rpm),l(h.kmh)):this.ctx.lineTo(a(h.rpm),l(h.kmh))}),this.ctx.stroke()}),this.ctx.font="8px system-ui",this.ctx.textAlign="left",i.forEach(({gear:o},n)=>{const d=E[n%E.length];this.ctx.fillStyle=d,this.ctx.fillText(`${o}`,e.left+t+2,e.top+6+n*10)})}}class fe{container;groups;activeId;activeProfile;onSelect;viewMode="carousel";isCompact=!1;detailCharts=null;constructor(e,t,s,a){this.container=document.getElementById(e),this.groups=t,this.activeId=s.id,this.activeProfile=s,this.onSelect=a,this.render()}setCompact(e){this.isCompact!==e&&(this.isCompact=e,this.render())}render(){this.detailCharts?.destroy(),this.detailCharts=null,this.container.innerHTML="",this.container.className=this.isCompact?"vehicle-gallery compact":"vehicle-gallery",this.viewMode==="carousel"?this.renderCarousel():this.renderDetail()}renderCarousel(){const e=document.createElement("div");e.className=this.isCompact?"gallery-carousel compact":"gallery-carousel";for(const t of this.groups)for(const s of t.profiles){const a=document.createElement("div");if(a.className=s.id===this.activeId?"vehicle-card active":"vehicle-card",this.isCompact)a.innerHTML=`
            <img src="${s.imageUrl||""}" alt="${s.name}" loading="lazy" />
            <span class="vehicle-card-name-compact">${s.name.split(" ")[0]}</span>
          `;else{const r=s.peakPower,l=s.peakTorque;a.innerHTML=`
            <img src="${s.imageUrl||""}" alt="${s.name}" loading="lazy" />
            <div class="vehicle-card-info">
              <div class="vehicle-card-name">${s.name}</div>
              <div class="vehicle-card-stats">${r} kW · ${l} Nm · ${s.displacement}cc</div>
            </div>
          `}a.querySelector("img")?.addEventListener("click",r=>{r.stopPropagation(),s.id!==this.activeId&&(this.activeId=s.id,this.activeProfile=s,this.onSelect(s)),this.viewMode="detail",this.render()}),a.addEventListener("click",r=>{r.target.closest("img")||s.id!==this.activeId&&(this.activeId=s.id,this.activeProfile=s,this.onSelect(s),this.render())}),e.appendChild(a)}this.container.appendChild(e)}renderDetail(){const e=this.activeProfile,t=document.createElement("div");t.className="vehicle-detail-panel";const s=e.gearRatios.length,a=e.aspiration==="turbo"?"Turbo":e.aspiration==="turbo-diesel"?"Turbo Diesel":"Atmosphérique",i=e.driveType==="fwd"?"Traction avant":e.driveType==="awd"?"Intégrale":e.driveType==="rwd"?"Traction arrière":"—";t.innerHTML=`
      <div class="detail-content">
        <div class="detail-photo" role="button" tabindex="0" aria-label="Retour à la galerie">
          <img src="${e.imageUrl||""}" alt="${e.name}" />
        </div>
        <div class="detail-right mode-specs">
          <div class="detail-header">
            <h3 class="detail-title">${e.name}</h3>
            <div class="detail-toggle">
              <button type="button" class="detail-toggle-btn active" data-mode="specs">Fiche</button>
              <button type="button" class="detail-toggle-btn" data-mode="chart">Courbes</button>
            </div>
            <span class="detail-chart-name" aria-hidden="true"></span>
          </div>
          <div class="detail-body">
            <div class="detail-specs">
            <dl class="detail-grid">
              <dt>Type</dt><dd>${e.type}</dd>
              <dt>Cylindrée</dt><dd>${e.displacement} cc</dd>
              <dt>Cylindres</dt><dd>${e.cylinders}</dd>
              <dt>Aspiration</dt><dd>${a}</dd>
              <dt>Traction</dt><dd>${i}</dd>
              <dt>Puissance</dt><dd>${e.peakPower} kW @ ${e.peakPowerRPM}</dd>
              <dt>Couple</dt><dd>${e.peakTorque} Nm @ ${e.peakTorqueRPM}</dd>
              <dt>Redline</dt><dd>${e.redlineRPM} RPM</dd>
              <dt>Vitesses</dt><dd>${s}</dd>
              <dt>Masse</dt><dd>${e.vehicleMass} kg</dd>
              <dt>P/M</dt><dd>${(e.peakPower/e.vehicleMass*1e3).toFixed(1)} W/kg</dd>
            </dl>
            </div>
            <div class="detail-chart-wrap"></div>
          </div>
        </div>
      </div>
    `;const r=t.querySelector(".detail-photo");r?.addEventListener("click",()=>{this.viewMode="carousel",this.render()}),r?.addEventListener("keydown",d=>{const h=d;(h.key==="Enter"||h.key===" ")&&(d.preventDefault(),this.viewMode="carousel",this.render())});const l=t.querySelector(".detail-right"),c=t.querySelectorAll(".detail-toggle-btn");l&&c.length&&c.forEach(d=>{d.addEventListener("click",()=>{const h=d.dataset.mode==="chart"?"chart":"specs";l.classList.toggle("mode-specs",h==="specs"),l.classList.toggle("mode-chart",h==="chart"),c.forEach(u=>u.classList.toggle("active",u===d))})});const o=t.querySelector(".detail-chart-wrap"),n=t.querySelector(".detail-chart-name");o&&(this.detailCharts=new me(o,this.activeProfile,n)),this.container.appendChild(t)}}const ge="honda-k20a",ve="Honda K20A VTEC",be="https://upload.wikimedia.org/wikipedia/commons/thumb/9/97/Honda_FK8.jpg/300px-Honda_FK8.jpg",Me="inline-4",we=1998,Pe=4,Re="na",xe="fwd",Te=800,ye=8600,ke=206,$e=7e3,Se=162,Be=8e3,Ce=[[800,50],[1e3,90],[2e3,130],[3e3,155],[4e3,175],[5e3,190],[5500,185],[6e3,180],[6500,190],[7e3,206],[7500,200],[8e3,188],[8600,160]],_e=[1,3,4,2],qe=[3.267,2.105,1.481,1.161,.971,.811],Ae=4.764,Ee=.316,De={type:"sport",lowpassBaseFreq:1500,lowpassRpmScale:.3,lowpassQ:1.5,resonances:[{freq:600,Q:5,gainDB:8},{freq:1800,Q:3,gainDB:4},{freq:3500,Q:2,gainDB:3}]},Ge={numHarmonics:24,spectralRolloff:.9,firingHarmonicBoost:3,loadBrightness:.7},Le=1200,Oe=.31,Ie=2,Fe=.012,Ve={id:ge,name:ve,imageUrl:be,type:Me,displacement:we,cylinders:Pe,aspiration:Re,driveType:xe,idleRPM:Te,redlineRPM:ye,peakTorque:ke,peakTorqueRPM:$e,peakPower:Se,peakPowerRPM:Be,torqueCurve:Ce,firingOrder:_e,gearRatios:qe,finalDrive:Ae,wheelRadius:Ee,exhaustConfig:De,harmonicProfile:Ge,vehicleMass:Le,dragCoefficient:Oe,frontalArea:Ie,rollingResistance:Fe},He="toyota-2gr-fe",Ne="Toyota 2GR-FE V6",Ue="https://upload.wikimedia.org/wikipedia/commons/thumb/6/65/2021_Toyota_Camry_TRD_V6.jpg/300px-2021_Toyota_Camry_TRD_V6.jpg",Ke="v6",Qe=3456,We=6,ze="na",je="fwd",Je=650,Ye=6500,Xe=336,Ze=4700,et=200,tt=6200,it=[[650,80],[1e3,150],[1500,220],[2e3,270],[2500,300],[3e3,320],[3500,330],[4e3,334],[4700,336],[5e3,330],[5500,310],[6e3,280],[6500,240]],st=[1,2,3,4,5,6],at=[3.52,2.042,1.4,1,.716,.586],ot=3.933,nt=.33,rt={type:"stock",lowpassBaseFreq:900,lowpassRpmScale:.15,lowpassQ:.8,resonances:[{freq:450,Q:3,gainDB:5},{freq:1300,Q:2,gainDB:3}]},lt={numHarmonics:24,spectralRolloff:1,firingHarmonicBoost:3.5,loadBrightness:.6},ct=1600,ht=.3,dt=2.3,pt=.012,ut={id:He,name:Ne,imageUrl:Ue,type:Ke,displacement:Qe,cylinders:We,aspiration:ze,driveType:je,idleRPM:Je,redlineRPM:Ye,peakTorque:Xe,peakTorqueRPM:Ze,peakPower:et,peakPowerRPM:tt,torqueCurve:it,firingOrder:st,gearRatios:at,finalDrive:ot,wheelRadius:nt,exhaustConfig:rt,harmonicProfile:lt,vehicleMass:ct,dragCoefficient:ht,frontalArea:dt,rollingResistance:pt},mt="ford-coyote-50",ft="Ford Coyote 5.0 V8",gt="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/2018_Ford_Mustang_GT_5.0_Front.jpg/300px-2018_Ford_Mustang_GT_5.0_Front.jpg",vt="v8-crossplane",bt=5035,Mt=8,wt="na",Pt="rwd",Rt=700,xt=7500,Tt=569,yt=4600,kt=343,$t=7e3,St=[[700,100],[1e3,200],[1500,320],[2e3,400],[2500,460],[3e3,510],[3500,545],[4e3,560],[4600,569],[5e3,560],[5500,540],[6e3,510],[6500,470],[7e3,420],[7500,360]],Bt=[1,3,7,2,6,5,4,8],Ct=[3.657,2.18,1.452,1,.686,.58],_t=3.73,qt=.34,At={type:"sport",lowpassBaseFreq:1800,lowpassRpmScale:.35,lowpassQ:1.2,resonances:[{freq:350,Q:6,gainDB:10},{freq:800,Q:4,gainDB:6},{freq:2200,Q:2,gainDB:3}]},Et={numHarmonics:24,spectralRolloff:.8,firingHarmonicBoost:2.5,loadBrightness:.8},Dt=1700,Gt=.33,Lt=2.2,Ot=.013,It={id:mt,name:ft,imageUrl:gt,type:vt,displacement:bt,cylinders:Mt,aspiration:wt,driveType:Pt,idleRPM:Rt,redlineRPM:xt,peakTorque:Tt,peakTorqueRPM:yt,peakPower:kt,peakPowerRPM:$t,torqueCurve:St,firingOrder:Bt,gearRatios:Ct,finalDrive:_t,wheelRadius:qt,exhaustConfig:At,harmonicProfile:Et,vehicleMass:Dt,dragCoefficient:Gt,frontalArea:Lt,rollingResistance:Ot},Ft="bmw-b58",Vt="BMW B58 Turbo I6",Ht="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2d/BMW_M340i_%28G20%29_Washington_DC_Metro_Area%2C_USA.jpg/300px-BMW_M340i_%28G20%29_Washington_DC_Metro_Area%2C_USA.jpg",Nt="inline-6",Ut=2998,Kt=6,Qt="turbo",Wt="rwd",zt=700,jt=7e3,Jt=500,Yt=1600,Xt=285,Zt=5500,ei=[[700,100],[1e3,250],[1200,350],[1400,430],[1600,500],[2e3,500],[2500,500],[3e3,500],[3500,500],[4e3,500],[4500,500],[5e3,480],[5500,440],[6e3,390],[6500,350],[7e3,300]],ti=[1,5,3,6,2,4],ii=[4.714,3.143,2.106,1.667,1.285,1,.839,.667],si=3.154,ai=.33,oi={type:"sport",lowpassBaseFreq:1400,lowpassRpmScale:.25,lowpassQ:1.3,resonances:[{freq:500,Q:5,gainDB:7},{freq:1500,Q:3,gainDB:5},{freq:3e3,Q:2,gainDB:3}]},ni={numHarmonics:24,spectralRolloff:1,firingHarmonicBoost:3.5,loadBrightness:.65},ri={maxBoostBar:1.2,spoolTimeSec:.5,boostThresholdRPM:1500,hasBOV:!0},li=1600,ci=.29,hi=2.2,di=.011,pi={id:Ft,name:Vt,imageUrl:Ht,type:Nt,displacement:Ut,cylinders:Kt,aspiration:Qt,driveType:Wt,idleRPM:zt,redlineRPM:jt,peakTorque:Jt,peakTorqueRPM:Yt,peakPower:Xt,peakPowerRPM:Zt,torqueCurve:ei,firingOrder:ti,gearRatios:ii,finalDrive:si,wheelRadius:ai,exhaustConfig:oi,harmonicProfile:ni,turbo:ri,vehicleMass:li,dragCoefficient:ci,frontalArea:hi,rollingResistance:di},ui="ferrari-f136",mi="Ferrari F136 V8",fi="https://upload.wikimedia.org/wikipedia/commons/thumb/e/ea/White_Ferrari_458_Italia_front.JPG/300px-White_Ferrari_458_Italia_front.JPG",gi="v8-flatplane",vi=4497,bi=8,Mi="na",wi="rwd",Pi=1e3,Ri=9e3,xi=540,Ti=6e3,yi=419,ki=9e3,$i=[[1e3,100],[1500,180],[2e3,260],[2500,320],[3e3,380],[3500,420],[4e3,450],[4500,475],[5e3,500],[5500,525],[6e3,540],[6500,535],[7e3,520],[7500,495],[8e3,465],[8500,430],[9e3,390]],Si=[1,8,2,7,4,5,3,6],Bi=[3.08,2.19,1.63,1.29,1.03,.84,.64],Ci=4.44,_i=.33,qi={type:"straight-pipe",lowpassBaseFreq:3500,lowpassRpmScale:.4,lowpassQ:.7,resonances:[{freq:400,Q:7,gainDB:9},{freq:1100,Q:5,gainDB:6},{freq:3200,Q:3,gainDB:4}]},Ai={numHarmonics:28,spectralRolloff:.85,firingHarmonicBoost:3.5,loadBrightness:.75},Ei=1485,Di=.33,Gi=2,Li=.011,Oi={id:ui,name:mi,imageUrl:fi,type:gi,displacement:vi,cylinders:bi,aspiration:Mi,driveType:wi,idleRPM:Pi,redlineRPM:Ri,peakTorque:xi,peakTorqueRPM:Ti,peakPower:yi,peakPowerRPM:ki,torqueCurve:$i,firingOrder:Si,gearRatios:Bi,finalDrive:Ci,wheelRadius:_i,exhaustConfig:qi,harmonicProfile:Ai,vehicleMass:Ei,dragCoefficient:Di,frontalArea:Gi,rollingResistance:Li},Ii="vw-20-tdi",Fi="VW 2.0 TDI Diesel",Vi="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3e/VW_Golf_VII_Variant_Highline_2.0_TDI.JPG/300px-VW_Golf_VII_Variant_Highline_2.0_TDI.JPG",Hi="inline-4",Ni=1968,Ui=4,Ki="turbo-diesel",Qi="fwd",Wi=800,zi=5e3,ji=320,Ji=1750,Yi=103,Xi=4e3,Zi=[[800,80],[1e3,150],[1200,220],[1500,280],[1750,320],[2e3,320],[2500,320],[3e3,290],[3500,250],[4e3,210],[4500,170],[5e3,120]],es=[1,3,4,2],ts=[3.778,2.118,1.36,.971,.756,.635],is=3.45,ss=.32,as={type:"stock",lowpassBaseFreq:700,lowpassRpmScale:.12,lowpassQ:.6,resonances:[{freq:300,Q:3,gainDB:4},{freq:900,Q:2,gainDB:2}]},os={numHarmonics:20,spectralRolloff:1.2,firingHarmonicBoost:2.5,loadBrightness:.5},ns={maxBoostBar:1.8,spoolTimeSec:.8,boostThresholdRPM:1200,hasBOV:!1},rs=1450,ls=.3,cs=2.2,hs=.012,ds={id:Ii,name:Fi,imageUrl:Vi,type:Hi,displacement:Ni,cylinders:Ui,aspiration:Ki,driveType:Qi,idleRPM:Wi,redlineRPM:zi,peakTorque:ji,peakTorqueRPM:Ji,peakPower:Yi,peakPowerRPM:Xi,torqueCurve:Zi,firingOrder:es,gearRatios:ts,finalDrive:is,wheelRadius:ss,exhaustConfig:as,harmonicProfile:os,turbo:ns,vehicleMass:rs,dragCoefficient:ls,frontalArea:cs,rollingResistance:hs},ps="bugatti-chiron",us="Bugatti Chiron W16",ms="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6f/Bugatti_Chiron%2C_GIMS_2018%2C_Le_Grand-Saconnex_%281X7A1765%29.jpg/300px-Bugatti_Chiron%2C_GIMS_2018%2C_Le_Grand-Saconnex_%281X7A1765%29.jpg",fs="w16",gs=7993,vs=16,bs="turbo",Ms="awd",ws=700,Ps=6900,Rs=1600,xs=2e3,Ts=1103,ys=6700,ks=[[700,300],[1e3,600],[1500,1200],[2e3,1600],[2500,1600],[3e3,1600],[3500,1600],[4e3,1600],[4500,1550],[5e3,1500],[5500,1400],[6e3,1300],[6500,1200],[6900,1100]],$s=[1,12,7,4,15,6,13,8,3,16,11,2,9,14,5,10],Ss=[3.846,2.476,1.786,1.391,1.121,.943,.794],Bs=2.235,Cs=.36,_s={type:"sport",lowpassBaseFreq:1600,lowpassRpmScale:.3,lowpassQ:1,resonances:[{freq:400,Q:4,gainDB:8},{freq:1200,Q:3,gainDB:5},{freq:2800,Q:2,gainDB:3}]},qs={numHarmonics:28,spectralRolloff:1.1,firingHarmonicBoost:2,loadBrightness:.6},As={maxBoostBar:1.6,spoolTimeSec:.6,boostThresholdRPM:1500,hasBOV:!0},Es=1995,Ds=.35,Gs=2.07,Ls=.01,Os={id:ps,name:us,imageUrl:ms,type:fs,displacement:gs,cylinders:vs,aspiration:bs,driveType:Ms,idleRPM:ws,redlineRPM:Ps,peakTorque:Rs,peakTorqueRPM:xs,peakPower:Ts,peakPowerRPM:ys,torqueCurve:ks,firingOrder:$s,gearRatios:Ss,finalDrive:Bs,wheelRadius:Cs,exhaustConfig:_s,harmonicProfile:qs,turbo:As,vehicleMass:Es,dragCoefficient:Ds,frontalArea:Gs,rollingResistance:Ls},Is="lamborghini-aventador",Fs="Lamborghini Aventador V12",Vs="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c9/Lamborghini_Aventador_LP700-4.jpg/300px-Lamborghini_Aventador_LP700-4.jpg",Hs="v12",Ns=6498,Us=12,Ks="na",Qs="awd",Ws=800,zs=8500,js=690,Js=5500,Ys=566,Xs=8250,Zs=[[800,200],[1500,350],[2500,450],[3500,550],[4500,620],[5500,690],[6e3,680],[6500,660],[7e3,640],[7500,610],[8e3,570],[8500,520]],ea=[1,7,5,11,3,9,6,12,2,8,4,10],ta=[3.91,2.56,1.81,1.39,1.08,.88,.73],ia=3.21,sa=.35,aa={type:"straight-pipe",lowpassBaseFreq:3200,lowpassRpmScale:.4,lowpassQ:.8,resonances:[{freq:450,Q:6,gainDB:9},{freq:1100,Q:4,gainDB:6},{freq:2800,Q:3,gainDB:4}]},oa={numHarmonics:28,spectralRolloff:.85,firingHarmonicBoost:3,loadBrightness:.7},na=1575,ra=.33,la=2.12,ca=.01,ha={id:Is,name:Fs,imageUrl:Vs,type:Hs,displacement:Ns,cylinders:Us,aspiration:Ks,driveType:Qs,idleRPM:Ws,redlineRPM:zs,peakTorque:js,peakTorqueRPM:Js,peakPower:Ys,peakPowerRPM:Xs,torqueCurve:Zs,firingOrder:ea,gearRatios:ta,finalDrive:ia,wheelRadius:sa,exhaustConfig:aa,harmonicProfile:oa,vehicleMass:na,dragCoefficient:ra,frontalArea:la,rollingResistance:ca},da="porsche-911-gt3",pa="Porsche 911 GT3 Flat-6",ua="https://upload.wikimedia.org/wikipedia/commons/thumb/1/18/Porsche_911_GT3_4.0_%28992%29_1X7A7256.jpg/300px-Porsche_911_GT3_4.0_%28992%29_1X7A7256.jpg",ma="flat-6",fa=3996,ga=6,va="na",ba="rwd",Ma=900,wa=9e3,Pa=470,Ra=6100,xa=375,Ta=8400,ya=[[900,140],[1500,220],[2500,310],[3500,380],[4500,430],[5e3,450],[5500,460],[6100,470],[6500,465],[7e3,455],[7500,440],[8e3,420],[8400,400],[9e3,370]],ka=[1,6,2,4,3,5],$a=[3.31,2.16,1.61,1.27,1.03,.85,.71],Sa=3.44,Ba=.33,Ca={type:"sport",lowpassBaseFreq:2800,lowpassRpmScale:.5,lowpassQ:.9,resonances:[{freq:500,Q:5,gainDB:8},{freq:1400,Q:4,gainDB:5},{freq:3500,Q:2,gainDB:3}]},_a={numHarmonics:26,spectralRolloff:.85,firingHarmonicBoost:3.5,loadBrightness:.75},qa=1418,Aa=.34,Ea=2,Da=.01,Ga={id:da,name:pa,imageUrl:ua,type:ma,displacement:fa,cylinders:ga,aspiration:va,driveType:ba,idleRPM:Ma,redlineRPM:wa,peakTorque:Pa,peakTorqueRPM:Ra,peakPower:xa,peakPowerRPM:Ta,torqueCurve:ya,firingOrder:ka,gearRatios:$a,finalDrive:Sa,wheelRadius:Ba,exhaustConfig:Ca,harmonicProfile:_a,vehicleMass:qa,dragCoefficient:Aa,frontalArea:Ea,rollingResistance:Da},La="ducati-panigale-v4",Oa="Ducati Panigale V4",Ia="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e1/Ducati_Panigale_V4_Las_Vegas.jpg/300px-Ducati_Panigale_V4_Las_Vegas.jpg",Fa="v4",Va=1103,Ha=4,Na="na",Ua="rwd",Ka=1200,Qa=14500,Wa=124,za=1e4,ja=157,Ja=13e3,Ya=[[1200,35],[2e3,50],[3e3,65],[4e3,78],[5e3,88],[6e3,97],[7e3,105],[8e3,112],[9e3,119],[1e4,124],[11e3,122],[12e3,118],[13e3,112],[14e3,100],[14500,90]],Xa=[1,3,2,4],Za=[2.93,2.15,1.76,1.52,1.36,1.24],eo=2.93,to=.31,io={type:"sport",lowpassBaseFreq:2400,lowpassRpmScale:.6,lowpassQ:.8,resonances:[{freq:600,Q:5,gainDB:8},{freq:1600,Q:4,gainDB:5},{freq:4e3,Q:2,gainDB:3}]},so={numHarmonics:24,spectralRolloff:.8,firingHarmonicBoost:3,loadBrightness:.8},ao=198,oo=.6,no=.55,ro=.012,lo={id:La,name:Oa,imageUrl:Ia,type:Fa,displacement:Va,cylinders:Ha,aspiration:Na,driveType:Ua,idleRPM:Ka,redlineRPM:Qa,peakTorque:Wa,peakTorqueRPM:za,peakPower:ja,peakPowerRPM:Ja,torqueCurve:Ya,firingOrder:Xa,gearRatios:Za,finalDrive:eo,wheelRadius:to,exhaustConfig:io,harmonicProfile:so,vehicleMass:ao,dragCoefficient:oo,frontalArea:no,rollingResistance:ro},co="yamaha-r1",ho="Yamaha YZF-R1",po="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e1/2015_Yamaha_YZF-R1.JPG/300px-2015_Yamaha_YZF-R1.JPG",uo="inline-4",mo=998,fo=4,go="na",vo="rwd",bo=1100,Mo=13500,wo=113,Po=11500,Ro=147,xo=13e3,To=[[1100,30],[2e3,42],[3e3,55],[4e3,65],[5e3,75],[6e3,83],[7e3,90],[8e3,96],[9e3,102],[1e4,107],[11e3,111],[11500,113],[12e3,110],[13e3,105],[13500,95]],yo=[1,3,2,4],ko=[2.85,2.06,1.69,1.45,1.29,1.16],$o=2.82,So=.31,Bo={type:"sport",lowpassBaseFreq:2200,lowpassRpmScale:.55,lowpassQ:.8,resonances:[{freq:550,Q:5,gainDB:7},{freq:1500,Q:3,gainDB:5},{freq:3800,Q:2,gainDB:3}]},Co={numHarmonics:24,spectralRolloff:.85,firingHarmonicBoost:3,loadBrightness:.75},_o=201,qo=.58,Ao=.55,Eo=.012,Do={id:co,name:ho,imageUrl:po,type:uo,displacement:mo,cylinders:fo,aspiration:go,driveType:vo,idleRPM:bo,redlineRPM:Mo,peakTorque:wo,peakTorqueRPM:Po,peakPower:Ro,peakPowerRPM:xo,torqueCurve:To,firingOrder:yo,gearRatios:ko,finalDrive:$o,wheelRadius:So,exhaustConfig:Bo,harmonicProfile:Co,vehicleMass:_o,dragCoefficient:qo,frontalArea:Ao,rollingResistance:Eo},Go="harley-davidson-vtwin",Lo="Harley-Davidson V-Twin",Oo="https://upload.wikimedia.org/wikipedia/commons/thumb/9/99/Harley_Davidson_Fat_Boy_2018_FLFBS.jpg/300px-Harley_Davidson_Fat_Boy_2018_FLFBS.jpg",Io="v-twin",Fo=1868,Vo=2,Ho="na",No="rwd",Uo=800,Ko=5500,Qo=150,Wo=3e3,zo=65,jo=4800,Jo=[[800,50],[1e3,70],[1500,100],[2e3,125],[2500,140],[3e3,150],[3500,148],[4e3,142],[4500,132],[4800,120],[5e3,110],[5500,95]],Yo=[1,2],Xo=[3.36,2.3,1.65,1.29,1,.84],Zo=2.41,en=.33,tn={type:"straight-pipe",lowpassBaseFreq:1200,lowpassRpmScale:.35,lowpassQ:.7,resonances:[{freq:250,Q:4,gainDB:10},{freq:700,Q:3,gainDB:6},{freq:1500,Q:2,gainDB:3}]},sn={numHarmonics:20,spectralRolloff:.7,firingHarmonicBoost:4,loadBrightness:.6},an=320,on=.65,nn=.7,rn=.013,ln={id:Go,name:Lo,imageUrl:Oo,type:Io,displacement:Fo,cylinders:Vo,aspiration:Ho,driveType:No,idleRPM:Uo,redlineRPM:Ko,peakTorque:Qo,peakTorqueRPM:Wo,peakPower:zo,peakPowerRPM:jo,torqueCurve:Jo,firingOrder:Yo,gearRatios:Xo,finalDrive:Zo,wheelRadius:en,exhaustConfig:tn,harmonicProfile:sn,vehicleMass:an,dragCoefficient:on,frontalArea:nn,rollingResistance:rn},X=[{label:"Cars",profiles:[Ve,ut,It,pi,Oi,ds]},{label:"Supercars",profiles:[Os,ha,Ga]},{label:"Motos",profiles:[lo,Do,ln]}];function cn(){return X}function hn(){return X[0].profiles[0]}const W=.3,z=3e3;class dn{gpsWatchId=null;lastGpsSpeed=0;lastGpsTimestamp=0;prevGpsSpeed=0;prevGpsTimestamp=0;gpsAcceleration=0;gpsAccuracy=1/0;interpolatedSpeed=0;accelSmoothed=0;hasAccelerometer=!1;deviceMotionHandler=null;statusCallback=null;_isActive=!1;get isActive(){return this._isActive}onStatusChange(e){this.statusCallback=e}async start(){if(!window.isSecureContext){const e={state:"error",reason:"insecure-context"};return this.statusCallback?.(e),e}if(!navigator.geolocation){const e={state:"error",reason:"unavailable"};return this.statusCallback?.(e),e}return this.statusCallback?.({state:"requesting"}),await this.requestAccelerometerPermission(),new Promise(e=>{this.gpsWatchId=navigator.geolocation.watchPosition(t=>{if(this.handleGpsUpdate(t),!this._isActive){this._isActive=!0;const s={state:"active",accuracy:t.coords.accuracy};this.statusCallback?.(s),e(s)}},t=>{if(!this._isActive){const a={state:"error",reason:t.code===1?"permission-denied":t.code===3?"timeout":"unavailable"};this.statusCallback?.(a),e(a)}},{enableHighAccuracy:!0,maximumAge:0,timeout:5e3}),this.startAccelerometer()})}stop(){this.gpsWatchId!==null&&(navigator.geolocation.clearWatch(this.gpsWatchId),this.gpsWatchId=null),this.deviceMotionHandler&&(window.removeEventListener("devicemotion",this.deviceMotionHandler),this.deviceMotionHandler=null),this._isActive=!1,this.interpolatedSpeed=0,this.lastGpsSpeed=0,this.accelSmoothed=0,this.gpsAcceleration=0,this.statusCallback?.({state:"inactive"})}update(e){const s=performance.now()-this.lastGpsTimestamp;return s>z&&this.lastGpsTimestamp>0||this.hasAccelerometer&&this.lastGpsTimestamp>0&&(this.interpolatedSpeed=Math.max(0,this.interpolatedSpeed+this.accelSmoothed*e)),{speedMs:this.interpolatedSpeed,accelerationMs2:this.lastGpsTimestamp>0?this.gpsAcceleration:0,gpsAccuracy:this.gpsAccuracy,isGpsActive:this._isActive&&s<z}}handleGpsUpdate(e){const t=e.coords.speed??0,s=performance.now();if(this.prevGpsSpeed=this.lastGpsSpeed,this.prevGpsTimestamp=this.lastGpsTimestamp,this.prevGpsTimestamp>0){const a=(s-this.prevGpsTimestamp)/1e3;a>.01&&(this.gpsAcceleration=(t-this.prevGpsSpeed)/a)}this.lastGpsSpeed=t,this.lastGpsTimestamp=s,this.gpsAccuracy=e.coords.accuracy,this.interpolatedSpeed=t,this._isActive&&this.statusCallback?.({state:"active",accuracy:this.gpsAccuracy})}async requestAccelerometerPermission(){const e=DeviceMotionEvent;if(typeof e.requestPermission=="function")try{if(await e.requestPermission()!=="granted")return}catch{return}}startAccelerometer(){this.deviceMotionHandler=e=>{const t=e.acceleration||e.accelerationIncludingGravity;if(!t)return;const s=t.x??0,a=t.y??0,i=Math.sqrt(s*s+a*a),r=this.gpsAcceleration>=0?i:-i;this.accelSmoothed=this.accelSmoothed*(1-W)+r*W,this.hasAccelerometer=!0},window.addEventListener("devicemotion",this.deviceMotionHandler)}}const pn=.15,un=5,mn=8;class fn{smoothedThrottle=0;smoothedBrake=0;revLimiterPhase=0;prevThrottle=0;turboModel=null;setTurbo(e){this.turboModel=e?new I(e):null}update(e,t,s,a,i,r){const{speedMs:l,accelerationMs2:c}=e,o=c>0?Math.min(1,c/un):0,n=c<0?Math.min(1,-c/mn):0,d=l<.5&&o<.05?.05:o,h=Math.min(1,a/pn);this.smoothedThrottle+=(d-this.smoothedThrottle)*h,this.smoothedBrake+=(n-this.smoothedBrake)*h,s.gear===0&&l>.5&&s.shiftUp(i);const u=s.gear;let m=u>=1?s.speedToRPM(l,u):t.idleRPM;u>=1&&l>0?m=Math.max(t.idleRPM,Math.min(t.redlineRPM,m)):m=J(m,t),r==="automatic"&&s.checkAutoShift(m,this.smoothedThrottle,i);const v=j(m,this.smoothedThrottle,t);let f=0,P=0,R=v;if(this.turboModel&&t.turbo){const M=this.turboModel.update(m,this.smoothedThrottle,a);f=M.boostBar,P=M.bovEnvelope;const g=f/t.turbo.maxBoostBar;R=v*(.65+.35*g)}const b=Y(m,t,this.revLimiterPhase,a);this.revLimiterPhase=b.newPhase,R*=b.torqueMultiplier;const{kw:k,hp:S}=F(R,m),B=this.prevThrottle>.7&&this.smoothedThrottle<.2&&m>t.redlineRPM*.6;return this.prevThrottle=this.smoothedThrottle,{engineState:{rpm:m,throttle:this.smoothedThrottle,brake:this.smoothedBrake,gear:u,speedMs:l,speedKmh:l*3.6,accelerationMs2:c,accelerationG:c/9.81,torqueNm:R,powerKw:k,powerHp:S,boostBar:f,isShifting:s.isShifting,transmissionMode:r,revLimiterActive:b.torqueMultiplier<.5,wheelSlip:0,launchControlActive:!1},decelCrackle:B,bovEnvelope:P}}reset(){this.smoothedThrottle=0,this.smoothedBrake=0,this.revLimiterPhase=0,this.prevThrottle=0,this.turboModel&&(this.turboModel=null)}}class gn{profile;transmission;vehicleDynamics;turboModel=null;audioEngine;dashboard;controls;state;isRunning=!1;lastTimestamp=0;animFrameId=0;revLimiterPhase=0;startupBlipTimer=0;prevThrottle=0;launchControlActive=!1;launchPhaseTimer=0;gallery;sensorProvider;evLoop;inputMode="keyboard";constructor(){this.profile=hn(),this.transmission=new D(this.profile),this.vehicleDynamics=new H(this.profile),this.profile.turbo&&(this.turboModel=new I(this.profile.turbo)),this.audioEngine=new ce,this.dashboard=new he("tachometer-canvas","gauges",this.profile),this.controls=new de("controls-container"),this.gallery=new fe("profile-selector-container",cn(),this.profile,e=>this.switchProfile(e)),this.sensorProvider=new dn,this.evLoop=new fn,this.state=this.createInitialState(),this.controls.onVolumeChange(e=>this.audioEngine.setVolume(e)),this.controls.onInputModeChange(e=>this.switchInputMode(e)),this.sensorProvider.onStatusChange(e=>this.controls.setEvStatus(e)),this.controls.onPowerChange(async e=>{e?await this.engineOn():this.engineOff()}),this.dashboard.render(this.state),this.controls.updateGearDisplay(0,!1)}async engineOn(){this.isRunning||(await this.audioEngine.initialize(this.profile),this.audioEngine.start(),await this.audioEngine.playStarterSound(),this.state=this.createInitialState(),this.revLimiterPhase=0,this.startupBlipTimer=.3,this.launchControlActive=!1,this.launchPhaseTimer=0,this.isRunning=!0,this.gallery.setCompact(!0),this.lastTimestamp=performance.now(),this.animFrameId=requestAnimationFrame(e=>this.loop(e)))}engineOff(){this.isRunning=!1,this.gallery.setCompact(!1),cancelAnimationFrame(this.animFrameId),this.state={...this.state,rpm:0,throttle:0,gear:0,speedMs:0,speedKmh:0,accelerationMs2:0,accelerationG:0,torqueNm:0,powerKw:0,powerHp:0,boostBar:0,revLimiterActive:!1,wheelSlip:0,launchControlActive:!1},this.dashboard.render(this.state),this.controls.updateGearDisplay(0,!1),this.audioEngine.stop(),this.vehicleDynamics.reset(),this.transmission.reset(),this.inputMode==="ev-augmented"&&(this.sensorProvider.stop(),this.inputMode="keyboard",this.controls.revertToKeyboard())}async switchInputMode(e){if(e!==this.inputMode)if(e==="ev-augmented"){if((await this.sensorProvider.start()).state==="error"){this.controls.revertToKeyboard();return}this.inputMode="ev-augmented",this.evLoop.reset(),this.evLoop.setTurbo(this.profile.turbo),this.isRunning||this.controls.simulatePowerOn(),this.transmission.gear===0&&this.transmission.shiftUp(performance.now())}else this.sensorProvider.stop(),this.inputMode="keyboard"}loop(e){if(!this.isRunning)return;const t=Math.min((e-this.lastTimestamp)/1e3,.05);this.lastTimestamp=e,this.inputMode==="ev-augmented"?this.loopEvAugmented(t,e):this.loopKeyboard(t,e),this.audioEngine.update(this.state),this.audioEngine.updateTireSqueal(this.state.wheelSlip),this.dashboard.render(this.state),this.controls.updateGearDisplay(this.transmission.gear,this.transmission.isShifting),this.animFrameId=requestAnimationFrame(s=>this.loop(s))}loopEvAugmented(e,t){const s=this.controls.update(e);this.transmission.update(e),this.transmission.mode=s.transmissionMode,s.shiftUpPressed&&(s.transmissionMode==="automatic"&&this.transmission.gear>0?this.transmission.manualOverrideShift("up",t):this.transmission.shiftUp(t)),s.shiftDownPressed&&(s.transmissionMode==="automatic"&&this.transmission.gear>0?this.transmission.manualOverrideShift("down",t):this.transmission.shiftDown(t,this.state.speedMs));const a=this.sensorProvider.update(e),i=this.evLoop.update(a,this.profile,this.transmission,e,t,s.transmissionMode);this.state=i.engineState,i.decelCrackle&&this.audioEngine.triggerDecelCrackle(),i.bovEnvelope>.01&&this.audioEngine.triggerBOV(i.bovEnvelope),this.state.revLimiterActive&&this.audioEngine.triggerRevLimiterPop()}loopKeyboard(e,t){const s=this.controls.update(e);if(this.startupBlipTimer>0){this.startupBlipTimer-=e;const M=Math.max(0,this.startupBlipTimer/.3);s.throttle=Math.max(s.throttle,.3*M)}this.transmission.update(e),this.transmission.mode=s.transmissionMode,s.shiftUpPressed&&(s.transmissionMode==="automatic"&&this.transmission.gear>0?this.transmission.manualOverrideShift("up",t):this.transmission.shiftUp(t)),s.shiftDownPressed&&(s.transmissionMode==="automatic"&&this.transmission.gear>0?this.transmission.manualOverrideShift("down",t):this.transmission.shiftDown(t,this.state.speedMs)),this.transmission.gear===1&&s.brake>.5&&s.throttle>.8&&this.state.speedMs<1?this.launchControlActive=!0:this.launchControlActive&&(s.brake<.1?(this.launchControlActive=!1,this.launchPhaseTimer=1.5):s.throttle<.3&&(this.launchControlActive=!1,this.launchPhaseTimer=0)),this.launchPhaseTimer>0&&(this.launchPhaseTimer=Math.max(0,this.launchPhaseTimer-e)),this.launchControlActive&&s.brake>.3&&this.vehicleDynamics.reset();const i=12,r=this.state.speedMs,l=this.transmission.gear,c=l>=1?this.transmission.speedToRPM(r,l):this.profile.idleRPM;let o=1,n;if(l===0)n=this.state.rpm;else if(this.launchControlActive)n=this.state.rpm,o=0;else if(r<i&&l>=1){const M=r/i;if(o=Math.min(1,M*M),this.launchPhaseTimer>0){const g=.2+.8*(1-this.launchPhaseTimer/1.5);o*=g}s.throttle<.05?(n=this.profile.idleRPM,o=0):(o=Math.max(.35*s.throttle,o),n=(this.profile.idleRPM+s.throttle*(this.profile.redlineRPM-this.profile.idleRPM)*.85)*(1-o)+c*o,n=Math.max(n,this.profile.idleRPM))}else n=Math.max(c,this.profile.idleRPM);const d=j(n,s.throttle,this.profile);let h=0;if(this.turboModel){const M=this.turboModel.update(n,s.throttle,e);h=M.boostBar,M.bovActive&&this.audioEngine.triggerBOV(M.bovEnvelope)}let u;if(this.profile.turbo&&this.turboModel){const M=h/this.profile.turbo.maxBoostBar;u=d*(.65+.35*M)}else u=d;const m=Y(n,this.profile,this.revLimiterPhase,e);this.revLimiterPhase=m.newPhase,u*=m.torqueMultiplier,m.popTriggered&&this.audioEngine.triggerRevLimiterPop();const v=u;o===0&&(u=0);const{speedMs:f,accelerationMs2:P,wheelSlip:R}=this.vehicleDynamics.update(e,u,this.transmission.gear,s.brake,this.transmission.isShifting);let b;const k=this.transmission.speedToRPM(f,this.transmission.gear);if(l===0){let g=s.throttle>.05?this.profile.idleRPM+s.throttle*(this.profile.redlineRPM-this.profile.idleRPM)*1.05:this.profile.idleRPM;this.state.rpm>=this.profile.redlineRPM-100&&m.torqueMultiplier<.1&&(g=Math.min(g,this.profile.redlineRPM-200));const x=g>this.state.rpm?.15:.4;b=this.state.rpm+(g-this.state.rpm)*Math.min(1,e/x)}else if(this.launchControlActive){const M=Math.min(this.profile.peakPowerRPM*.7,this.profile.redlineRPM*.65);b=this.state.rpm+(M-this.state.rpm)*Math.min(1,e/.1)}else if(o<.99&&l>=1&&s.throttle>=.05){const M=f/i;let g=Math.min(1,M*M);if(this.launchPhaseTimer>0){const T=.2+.8*(1-this.launchPhaseTimer/1.5);g*=T}g=Math.max(.35*s.throttle,g),b=(this.profile.idleRPM+s.throttle*(this.profile.redlineRPM-this.profile.idleRPM)*.85)*(1-g)+k*g,b=Math.max(b,this.profile.idleRPM)}else l>=1?b=f<=0?this.profile.idleRPM:k:b=this.profile.idleRPM;l>=1&&f>0&&o>=.99?b=Math.max(0,Math.min(this.profile.redlineRPM,b)):b=J(b,this.profile),s.transmissionMode==="automatic"&&this.transmission.checkAutoShift(b,s.throttle,t);const S=this.launchControlActive?v:u,{kw:B,hp:C}=F(S,b);this.state={rpm:b,throttle:s.throttle,brake:s.brake,gear:this.transmission.gear,speedMs:f,speedKmh:f*3.6,accelerationMs2:P,accelerationG:P/9.81,torqueNm:S,powerKw:B,powerHp:C,boostBar:h,isShifting:this.transmission.isShifting,transmissionMode:s.transmissionMode,revLimiterActive:m.torqueMultiplier<.5,wheelSlip:R,launchControlActive:this.launchControlActive},this.prevThrottle>.7&&s.throttle<.2&&b>this.profile.redlineRPM*.6&&this.audioEngine.triggerDecelCrackle(),this.prevThrottle=s.throttle}async switchProfile(e){this.profile=e,this.transmission=new D(e),this.vehicleDynamics=new H(e),this.turboModel=e.turbo?new I(e.turbo):null,this.vehicleDynamics.reset(),this.revLimiterPhase=0,this.launchControlActive=!1,this.launchPhaseTimer=0,this.dashboard.setProfile(e),this.isRunning&&await this.audioEngine.switchProfile(e),this.evLoop.reset(),this.evLoop.setTurbo(e.turbo),this.state=this.createInitialState()}createInitialState(){return{rpm:this.isRunning?this.profile.idleRPM:0,throttle:0,brake:0,gear:0,speedMs:0,speedKmh:0,accelerationMs2:0,accelerationG:0,torqueNm:0,powerKw:0,powerHp:0,boostBar:0,isShifting:!1,transmissionMode:"automatic",revLimiterActive:!1,wheelSlip:0,launchControlActive:!1}}}new gn;
