(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function t(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(a){if(a.ep)return;a.ep=!0;const s=t(a);fetch(a.href,s)}})();function ee(p,e){if(e.length===0)return 0;if(p<=e[0][0])return e[0][1];if(p>=e[e.length-1][0])return e[e.length-1][1];for(let t=0;t<e.length-1;t++){const[i,a]=e[t],[s,r]=e[t+1];if(p>=i&&p<=s){const l=(p-i)/(s-i);return a+l*(r-a)}}return e[e.length-1][1]}function Y(p,e,t){return ee(p,t.torqueCurve)*Math.pow(Math.max(0,e),1.5)}function F(p,e){const i=p*e*(2*Math.PI/60)/1e3;return{kw:i,hp:i*1.341}}function J(p,e){return Math.max(e.idleRPM,Math.min(p,e.redlineRPM))}const te=15;function X(p,e,t,i){if(p<e.redlineRPM-100)return{torqueMultiplier:1,newPhase:0,popTriggered:!1};const a=(t+i*te)%1,s=a<.5,r=s&&t>=.5;return{torqueMultiplier:s?.05:.7,newPhase:a,popTriggered:r}}const H=2*Math.PI,A=800,se=450,ie=280,ae=120,oe=.82,V=.25,ne=.22;class D{_gear=0;_isShifting=!1;shiftTimer=0;lastShiftTime=0;_mode="automatic";profile;manualOverrideUntil=0;static MANUAL_OVERRIDE_DURATION_MS=2500;constructor(e){this.profile=e}get gear(){return this._gear}get isShifting(){return this._isShifting}get maxGear(){return this.profile.gearRatios.length}get mode(){return this._mode}set mode(e){this._mode=e}setProfile(e){this.profile=e,this._gear=0,this._isShifting=!1,this.manualOverrideUntil=0}speedToRPM(e,t){if(t<1||t>this.maxGear)return this.profile.idleRPM;const i=this.profile.gearRatios[t-1];return e*i*this.profile.finalDrive*60/(H*this.profile.wheelRadius)}rpmToSpeed(e,t){if(t<1||t>this.maxGear)return 0;const i=this.profile.gearRatios[t-1];return e*H*this.profile.wheelRadius/(i*this.profile.finalDrive*60)}update(e){this._isShifting&&(this.shiftTimer-=e*1e3,this.shiftTimer<=0&&(this._isShifting=!1))}checkAutoShift(e,t,i,a){if(this._mode!=="automatic"||this._isShifting||this._gear===0||a<this.manualOverrideUntil)return;const s=a-this.lastShiftTime,r=t>=oe,l=r?ie:t<V?se:A;if(s<l)return;const{peakPowerRPM:c,peakTorqueRPM:o,redlineRPM:n}=this.profile,d=t>=ne,h=c*(.6+.35*t),u=t<V?.58:.45+.35*t,m=o*u,g=this._gear>1?this.speedToRPM(i,this._gear-1):e,f=o*1,b=n*1.05;r&&e<f&&this._gear>1&&g<=b?this.doShift(this._gear-1,a):e<m&&this._gear>1?this.doShift(this._gear-1,a):d&&e>h&&this._gear<this.maxGear&&this.doShift(this._gear+1,a)}shiftUp(e){this._isShifting||this._gear>=this.maxGear||e-this.lastShiftTime<A||this.doShift(this._gear+1,e)}shiftDown(e,t=0){this._isShifting||this._gear<=0||e-this.lastShiftTime<A||this._gear===1&&t>=1||this.doShift(this._gear-1,e)}manualOverrideShift(e,t){if(this._isShifting||t-this.lastShiftTime<A||this._gear===0)return;const i=e==="up"?Math.min(this._gear+1,this.maxGear):Math.max(this._gear-1,1);i!==this._gear&&(this.doShift(i,t),this.manualOverrideUntil=t+D.MANUAL_OVERRIDE_DURATION_MS)}doShift(e,t){this._isShifting=!0,this.shiftTimer=ae,this.lastShiftTime=t,this._gear=e}reset(){this._gear=0,this._isShifting=!1,this.shiftTimer=0,this.lastShiftTime=0,this.manualOverrideUntil=0}}const re=1.225,L=9.81,le=.85,ce=[0,.25,.15,.1,.08,.06,.05,.04,.035],he=1.2;function de(p){switch(p.driveType||"rwd"){case"awd":return .95;case"fwd":return .55;case"rwd":return .5;default:return .5}}class N{_speedMs=0;_accelerationMs2=0;_wheelSlip=0;profile;constructor(e){this.profile=e}get speedMs(){return this._speedMs}get accelerationMs2(){return this._accelerationMs2}get wheelSlip(){return this._wheelSlip}setProfile(e){this.profile=e}update(e,t,i,a,s){const r=this.profile;let l=0;if(!s&&i>=1&&i<=r.gearRatios.length){const b=r.gearRatios[i-1];l=t*b*r.finalDrive*le/r.wheelRadius}const c=de(r),o=he*r.vehicleMass*c*L;this._wheelSlip=0,l>o&&l>0&&(this._wheelSlip=Math.min(1,(l-o)/o),l=o*(1-.3*this._wheelSlip));const n=r.vehicleMass*L*.8,d=a*n,h=.5*r.dragCoefficient*re*r.frontalArea*this._speedMs*this._speedMs,u=r.rollingResistance*r.vehicleMass*L,m=l-d-h-u,g=ce[i]??.05,f=r.vehicleMass*(1+g);return this._accelerationMs2=m/f,this._speedMs=Math.max(0,this._speedMs+this._accelerationMs2*e),{speedMs:this._speedMs,accelerationMs2:this._accelerationMs2,wheelSlip:this._wheelSlip}}reset(){this._speedMs=0,this._accelerationMs2=0,this._wheelSlip=0}}class O{boostActual=0;bovTriggered=!1;bovTime=0;prevThrottle=0;config;constructor(e){this.config=e}setConfig(e){this.config=e}update(e,t,i){const a=this.config;let s=0;if(e>=a.boostThresholdRPM){const o=Math.min(1,(e-a.boostThresholdRPM)/2e3);s=a.maxBoostBar*t*o}const r=a.spoolTimeSec*(a.boostThresholdRPM/Math.max(e,a.boostThresholdRPM)),l=Math.max(r,.01);this.boostActual+=(s-this.boostActual)*(i/l);let c=0;return a.hasBOV&&t<.1&&this.boostActual>.3&&this.prevThrottle>.3&&(this.bovTriggered=!0,this.bovTime=0,this.boostActual*=.5),this.bovTriggered&&(this.bovTime+=i,c=this.bovTime<.01?this.bovTime/.01:Math.exp(-(this.bovTime-.01)/.2),c<.01&&(this.bovTriggered=!1,c=0)),this.prevThrottle=t,{boostBar:Math.max(0,this.boostActual),bovActive:this.bovTriggered,bovEnvelope:c}}reset(){this.boostActual=0,this.bovTriggered=!1,this.bovTime=0,this.prevThrottle=0}}class ue{lowpass;peakingFilters;_input;_output;get input(){return this._input}get output(){return this._output}constructor(e,t){this.lowpass=e.createBiquadFilter(),this.lowpass.type="lowpass",this.lowpass.frequency.value=t.lowpassBaseFreq,this.lowpass.Q.value=t.lowpassQ,this.peakingFilters=t.resonances.map(a=>{const s=e.createBiquadFilter();return s.type="peaking",s.frequency.value=a.freq,s.Q.value=a.Q,s.gain.value=a.gainDB,s});let i=this.lowpass;for(const a of this.peakingFilters)i.connect(a),i=a;this._input=this.lowpass,this._output=this.peakingFilters.length>0?this.peakingFilters[this.peakingFilters.length-1]:this.lowpass}update(e,t){const i=t.lowpassBaseFreq+e*t.lowpassRpmScale;this.lowpass.frequency.setTargetAtTime(i,0,.03)}disconnect(){this.lowpass.disconnect();for(const e of this.peakingFilters)e.disconnect()}}class pe{turboOsc;turboOsc2;turboGain;turboBandpass;bovGain;bovBandpass;mixerGain;ctx;noiseBuffer;activeBovSource=null;get output(){return this.mixerGain}constructor(e,t){this.ctx=e,this.turboOsc=e.createOscillator(),this.turboOsc.type="sine",this.turboOsc.frequency.value=2e3,this.turboOsc2=e.createOscillator(),this.turboOsc2.type="sine",this.turboOsc2.frequency.value=4e3,this.turboBandpass=e.createBiquadFilter(),this.turboBandpass.type="bandpass",this.turboBandpass.frequency.value=3e3,this.turboBandpass.Q.value=4,this.turboGain=e.createGain(),this.turboGain.gain.value=0;const i=e.createGain();i.gain.value=.3,this.turboOsc.connect(this.turboBandpass),this.turboOsc2.connect(i),i.connect(this.turboBandpass),this.turboBandpass.connect(this.turboGain),this.bovBandpass=e.createBiquadFilter(),this.bovBandpass.type="bandpass",this.bovBandpass.frequency.value=1200,this.bovBandpass.Q.value=3,this.bovGain=e.createGain(),this.bovGain.gain.value=0,this.bovBandpass.connect(this.bovGain),this.mixerGain=e.createGain(),this.mixerGain.gain.value=1,this.turboGain.connect(this.mixerGain),this.bovGain.connect(this.mixerGain),this.noiseBuffer=this.createNoiseBuffer(.5),this.turboOsc.start(),this.turboOsc2.start()}update(e,t){const i=2e3+e*8e3,a=e*.12;this.turboOsc.frequency.setTargetAtTime(i,0,.05),this.turboOsc2.frequency.setTargetAtTime(i*2,0,.05),this.turboGain.gain.setTargetAtTime(a,0,.03),this.turboBandpass.frequency.setTargetAtTime(i,0,.05)}triggerBOV(e){if(e>.01&&!this.activeBovSource){const t=this.ctx.createBufferSource();t.buffer=this.noiseBuffer,t.connect(this.bovBandpass),t.start(),this.activeBovSource=t,t.onended=()=>{this.activeBovSource=null}}this.bovGain.gain.setTargetAtTime(e*.4,0,.01)}disconnect(){this.turboOsc.stop(),this.turboOsc2.stop(),this.turboGain.disconnect(),this.bovGain.disconnect(),this.mixerGain.disconnect()}createNoiseBuffer(e){const t=Math.floor(this.ctx.sampleRate*e),i=this.ctx.createBuffer(1,t,this.ctx.sampleRate),a=i.getChannelData(0);for(let s=0;s<t;s++)a[s]=Math.random()*2-1;return i}}class me{ctx=null;testContext=null;workletNode=null;exhaustFilter=null;turboAudio=null;masterGain=null;compressor=null;profile=null;isRunning=!1;popNoiseBuffer=null;activePopSource=null;popGain=null;bassShelf=null;reverbConvolver=null;toneDryGain=null;toneWetGain=null;_crackleActive=!1;squealSource=null;squealGain=null;squealNoiseBuffer=null;async initialize(e){if(this.profile=e,this.testContext){try{this.testContext.close()}catch{}this.testContext=null}this.ctx=new AudioContext({latencyHint:"interactive"});const t=new URL(""+new URL("engine-worklet-BQmEtZle.js",import.meta.url).href,import.meta.url);await this.ctx.audioWorklet.addModule(t.href),this.buildGraph(e)}buildGraph(e){const t=this.ctx;this.workletNode=new AudioWorkletNode(t,"engine-worklet",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[1]}),this.exhaustFilter=new ue(t,e.exhaustConfig),e.turbo&&(this.turboAudio=new pe(t,e.turbo)),this.bassShelf=t.createBiquadFilter(),this.bassShelf.type="lowshelf",this.bassShelf.frequency.value=120,this.bassShelf.gain.value=0;const i=Math.min(2*t.sampleRate,96e3),a=t.createBuffer(1,i,t.sampleRate),s=a.getChannelData(0),l=.8*t.sampleRate;s[0]=1;for(let c=1;c<i;c++)s[c]=(Math.random()*2-1)*Math.exp(-c/l);this.reverbConvolver=t.createConvolver(),this.reverbConvolver.buffer=a,this.reverbConvolver.normalize=!0,this.toneDryGain=t.createGain(),this.toneDryGain.gain.value=1,this.toneWetGain=t.createGain(),this.toneWetGain.gain.value=0,this.compressor=t.createDynamicsCompressor(),this.compressor.threshold.value=-6,this.compressor.knee.value=3,this.compressor.ratio.value=12,this.compressor.attack.value=.003,this.compressor.release.value=.1,this.popGain=t.createGain(),this.popGain.gain.value=1,this.masterGain=t.createGain(),this.masterGain.gain.value=.7,this.workletNode.connect(this.exhaustFilter.input),this.exhaustFilter.output.connect(this.bassShelf),this.bassShelf.connect(this.toneDryGain),this.bassShelf.connect(this.reverbConvolver),this.reverbConvolver.connect(this.toneWetGain),this.toneDryGain.connect(this.compressor),this.toneWetGain.connect(this.compressor),this.turboAudio&&this.turboAudio.output.connect(this.compressor),this.compressor.connect(this.masterGain),this.popGain.connect(this.masterGain),this.masterGain.connect(t.destination),this.setupTireSqueal()}async start(){this.ctx&&(this.ctx.state==="suspended"&&await this.ctx.resume(),this.isRunning=!0)}stop(){if(this.isRunning=!1,this.squealSource){try{this.squealSource.stop()}catch{}this.squealSource=null}this.ctx&&this.ctx.state==="running"&&this.ctx.suspend()}update(e){!this.workletNode||!this.profile||!this.isRunning||(this.workletNode.port.postMessage({type:"params",params:{rpm:e.rpm,throttle:e.throttle,cylinders:this.profile.cylinders,engineType:this.profile.type,spectralRolloff:this.profile.harmonicProfile.spectralRolloff,firingHarmonicBoost:this.profile.harmonicProfile.firingHarmonicBoost,numHarmonics:this.profile.harmonicProfile.numHarmonics,boostBar:e.boostBar,isShifting:e.isShifting}}),this.exhaustFilter?.update(e.rpm,this.profile.exhaustConfig),this.turboAudio&&this.turboAudio.update(e.boostBar,e.rpm))}triggerBOV(e){this.turboAudio?.triggerBOV(e)}triggerRevLimiterPop(){if(!this.ctx||!this.popGain)return;const e=this.ctx;if(!this.popNoiseBuffer){const l=Math.floor(e.sampleRate*.15);this.popNoiseBuffer=e.createBuffer(1,l,e.sampleRate);const c=this.popNoiseBuffer.getChannelData(0);for(let o=0;o<l;o++)c[o]=Math.random()*2-1}if(this.activePopSource)return;const t=e.createBufferSource();t.buffer=this.popNoiseBuffer;const i=e.createBiquadFilter();i.type="bandpass",i.frequency.value=600+Math.random()*600,i.Q.value=4;const a=e.createGain(),s=e.currentTime,r=.05+Math.random()*.05;a.gain.setValueAtTime(0,s),a.gain.linearRampToValueAtTime(.9,s+.005),a.gain.exponentialRampToValueAtTime(.01,s+r),t.connect(i),i.connect(a),a.connect(this.popGain),t.start(s),t.stop(s+.15),this.activePopSource=t,t.onended=()=>{this.activePopSource=null}}triggerDecelCrackle(){if(!this.ctx||!this.popGain||this._crackleActive)return;const e=this.ctx;if(this._crackleActive=!0,!this.popNoiseBuffer){const s=Math.floor(e.sampleRate*.15);this.popNoiseBuffer=e.createBuffer(1,s,e.sampleRate);const r=this.popNoiseBuffer.getChannelData(0);for(let l=0;l<s;l++)r[l]=Math.random()*2-1}const t=10+Math.floor(Math.random()*11);let i=0;const a=e.currentTime;for(let s=0;s<t;s++){const r=.018+Math.random()*.035,c=Math.random()<.35?r*.5:r;i+=c;const o=e.createBufferSource();o.buffer=this.popNoiseBuffer;const n=e.createBiquadFilter();n.type="bandpass",n.frequency.value=180+Math.random()*550,n.Q.value=2+Math.random()*2;const d=e.createGain(),h=1-s/t*.6,u=Math.random()<.25?1.4:.85+Math.random()*.3,m=Math.min(1.2,h*u),g=.003+Math.random()*.003,f=.04+Math.random()*.04,b=a+i;d.gain.setValueAtTime(0,b),d.gain.linearRampToValueAtTime(Math.max(.2,m),b+g),d.gain.exponentialRampToValueAtTime(.01,b+f),o.connect(n),n.connect(d),d.connect(this.popGain),o.start(b),o.stop(b+Math.min(.1,f+.02))}setTimeout(()=>{this._crackleActive=!1},(i+.2)*1e3)}setupTireSqueal(){if(!this.ctx||!this.masterGain)return;const e=this.ctx,t=Math.floor(e.sampleRate*2);this.squealNoiseBuffer=e.createBuffer(1,t,e.sampleRate);const i=this.squealNoiseBuffer.getChannelData(0);for(let r=0;r<t;r++)i[r]=Math.random()*2-1;const a=e.createBufferSource();a.buffer=this.squealNoiseBuffer,a.loop=!0;const s=e.createBiquadFilter();s.type="bandpass",s.frequency.value=3e3,s.Q.value=3,this.squealGain=e.createGain(),this.squealGain.gain.value=0,a.connect(s),s.connect(this.squealGain),this.squealGain.connect(this.masterGain),a.start(),this.squealSource=a}updateTireSqueal(e){if(!this.squealGain||!this.ctx)return;const t=e>.1?Math.min(.5,e*.8):0;this.squealGain.gain.setTargetAtTime(t,this.ctx.currentTime,.05)}async playStarterSound(){if(!this.ctx)return;const e=this.ctx,t=e.currentTime,i=.5,a=Math.floor(e.sampleRate*i),s=e.createBuffer(1,a,e.sampleRate),r=s.getChannelData(0);for(let n=0;n<a;n++)r[n]=Math.random()*2-1;const l=e.createBufferSource();l.buffer=s;const c=e.createBiquadFilter();c.type="bandpass",c.Q.value=5,c.frequency.setValueAtTime(100,t),c.frequency.linearRampToValueAtTime(500,t+.4);const o=e.createGain();return o.gain.setValueAtTime(0,t),o.gain.linearRampToValueAtTime(.3,t+.05),o.gain.setValueAtTime(.3,t+.35),o.gain.linearRampToValueAtTime(0,t+.45),l.connect(c),c.connect(o),o.connect(this.compressor||e.destination),l.start(t),l.stop(t+i),new Promise(n=>setTimeout(n,500))}setVolume(e){this.masterGain&&this.masterGain.gain.setTargetAtTime(Math.max(0,Math.min(1,e)),0,.05)}setToneOptions(e){this.bassShelf&&(this.bassShelf.gain.value=Math.max(-6,Math.min(12,e.bassDb)));const t=Math.max(0,Math.min(1,e.reverbWet));this.toneDryGain&&this.toneDryGain.gain.setTargetAtTime(1-t,0,.05),this.toneWetGain&&this.toneWetGain.gain.setTargetAtTime(t,0,.05)}getDebugInfo(){const e=this.ctx??this.testContext;return e?{contextState:e.state,sampleRate:e.sampleRate,workletLoaded:this.workletNode!=null,source:this.ctx?"engine":"test",canPlay:e.state==="running"}:{contextState:"non initialis√©",sampleRate:null,workletLoaded:!1,source:"none",canPlay:!1}}async playHorn(){const e=this.ctx??this.testContext;if(e){e.state==="suspended"&&await e.resume(),this.scheduleHorn(e);return}this.testContext=new AudioContext;const t=this.testContext;t.state==="suspended"&&await t.resume(),setTimeout(()=>this.scheduleHorn(t),50)}scheduleHorn(e){const i=e.sampleRate,a=Math.floor(i*.5),s=e.createBuffer(1,a,i),r=s.getChannelData(0),l=440,c=554;for(let h=0;h<a;h++){const u=h/i,m=u<.02?u/.02:u>.5-.05?(.5-u)/.05:1;r[h]=m*.35*(Math.sin(2*Math.PI*l*u)+Math.sin(2*Math.PI*c*u))}const o=e.createBufferSource();o.buffer=s,o.connect(e.destination);const d=e.currentTime+.02;o.start(d),o.stop(d+.5)}async switchProfile(e){if(this.ctx){if(this.masterGain&&this.masterGain.gain.setTargetAtTime(0,this.ctx.currentTime,.15),await new Promise(t=>setTimeout(t,300)),this.squealSource){try{this.squealSource.stop()}catch{}this.squealSource=null}this.workletNode?.disconnect(),this.exhaustFilter?.disconnect(),this.bassShelf?.disconnect(),this.reverbConvolver?.disconnect(),this.toneDryGain?.disconnect(),this.toneWetGain?.disconnect(),this.turboAudio?.disconnect(),this.compressor?.disconnect(),this.popGain?.disconnect(),this.masterGain?.disconnect(),this.turboAudio=null,this.profile=e,this.buildGraph(e),this.masterGain&&(this.masterGain.gain.value=0,this.masterGain.gain.setTargetAtTime(.7,this.ctx.currentTime,.15))}}}class G{canvas;ctx2d;data=[];timer=0;isRecording=!1;milestones=[];maxSpeedKmh;maxTime=10;static SPEED_THRESHOLDS=[100,200];constructor(e,t){this.maxSpeedKmh=this.calculateDisplayMax(t),this.canvas=document.createElement("canvas"),this.canvas.id="perf-graph-canvas",this.ctx2d=this.canvas.getContext("2d"),document.getElementById(e).appendChild(this.canvas),this.setupResize(),this.resizeCanvas()}setProfile(e){this.maxSpeedKmh=this.calculateDisplayMax(e),this.reset()}reset(){this.data=[],this.milestones=[],this.timer=0,this.isRecording=!1}update(e){if(this.isRecording||e.gear>=1&&e.throttle>.1&&e.speedKmh<5&&(this.isRecording=!0,this.data=[],this.milestones=[],this.timer=0),!this.isRecording){this.draw();return}if(e.brake>.3||e.gear===0){this.isRecording=!1,this.draw();return}this.timer+=1/60,this.data.push({time:this.timer,speedKmh:e.speedKmh});for(const t of G.SPEED_THRESHOLDS)!this.milestones.find(i=>i.speedKmh===t)&&e.speedKmh>=t&&this.milestones.push({speedKmh:t,time:this.timer});this.timer>this.maxTime-1&&(this.maxTime=Math.ceil(this.timer+5)),this.data.length>1200&&(this.data=this.data.filter((t,i)=>i%2===0)),this.draw()}draw(){const e=this.ctx2d,t=this.canvas.width/(window.devicePixelRatio||1),i=this.canvas.height/(window.devicePixelRatio||1),a=window.devicePixelRatio||1;e.setTransform(a,0,0,a,0,0),e.clearRect(0,0,t,i);const s={top:10,right:12,bottom:22,left:40},r=t-s.left-s.right,l=i-s.top-s.bottom;if(r<20||l<20)return;e.fillStyle="rgba(15, 21, 41, 0.6)",e.strokeStyle="#2a2a4a",e.lineWidth=1,e.beginPath(),e.roundRect(0,0,t,i,6),e.fill(),e.stroke(),e.font="9px system-ui",e.textAlign="right",e.textBaseline="middle";const c=this.maxSpeedKmh>200?100:50;for(let n=0;n<=this.maxSpeedKmh;n+=c){const d=s.top+l-n/this.maxSpeedKmh*l;e.strokeStyle="#1e293b",e.beginPath(),e.moveTo(s.left,d),e.lineTo(s.left+r,d),e.stroke(),e.fillStyle="#556",e.fillText(String(n),s.left-4,d)}for(const n of G.SPEED_THRESHOLDS){if(n>this.maxSpeedKmh)continue;const d=s.top+l-n/this.maxSpeedKmh*l;e.strokeStyle=n===100?"rgba(234, 179, 8, 0.4)":"rgba(233, 69, 96, 0.4)",e.setLineDash([4,4]),e.beginPath(),e.moveTo(s.left,d),e.lineTo(s.left+r,d),e.stroke(),e.setLineDash([])}e.textAlign="center",e.textBaseline="top";const o=this.maxTime<=10?2:5;for(let n=0;n<=this.maxTime;n+=o){const d=s.left+n/this.maxTime*r;e.fillStyle="#556",e.fillText(`${n}s`,d,s.top+l+4)}if(this.data.length>1){e.beginPath(),e.strokeStyle="#22c55e",e.lineWidth=2,e.lineJoin="round";for(let n=0;n<this.data.length;n++){const d=this.data[n],h=s.left+d.time/this.maxTime*r,u=s.top+l-d.speedKmh/this.maxSpeedKmh*l;n===0?e.moveTo(h,u):e.lineTo(h,u)}e.stroke()}for(const n of this.milestones){const d=s.left+n.time/this.maxTime*r,h=s.top+l-n.speedKmh/this.maxSpeedKmh*l;e.beginPath(),e.arc(d,h,4,0,Math.PI*2),e.fillStyle=n.speedKmh===100?"#eab308":"#e94560",e.fill();const u=`0-${n.speedKmh}: ${n.time.toFixed(1)}s`;e.font="bold 10px system-ui";const g=e.measureText(u).width+10,f=16,b=Math.min(d+6,s.left+r-g),R=h-f-4;e.fillStyle=n.speedKmh===100?"rgba(234, 179, 8, 0.85)":"rgba(233, 69, 96, 0.85)",e.beginPath(),e.roundRect(b,R,g,f,3),e.fill(),e.fillStyle="#fff",e.textAlign="left",e.textBaseline="middle",e.fillText(u,b+5,R+f/2)}this.isRecording&&(e.fillStyle="#e94560",e.beginPath(),e.arc(t-16,14,4,0,Math.PI*2),e.fill(),e.fillStyle="#889",e.font="9px system-ui",e.textAlign="right",e.textBaseline="middle",e.fillText("REC",t-24,14))}calculateDisplayMax(e){const t=e.peakPower*1e3,i=1.225;let a=0,s=200;for(let l=0;l<50;l++){const c=(a+s)/2,o=.5*e.dragCoefficient*i*e.frontalArea*c*c*c,n=e.rollingResistance*e.vehicleMass*9.81*c;o+n<t*.85?a=c:s=c}const r=(a+s)/2*3.6;return Math.ceil(r/50)*50}setupResize(){new ResizeObserver(()=>this.resizeCanvas()).observe(this.canvas.parentElement)}resizeCanvas(){const t=this.canvas.parentElement.getBoundingClientRect(),i=window.devicePixelRatio||1,a=Math.min(t.width,600),s=120;this.canvas.width=a*i,this.canvas.height=s*i,this.canvas.style.width=`${a}px`,this.canvas.style.height=`${s}px`,this.draw()}}class fe{canvas;ctx2d;gaugesEl;profile;logicalW=600;logicalH=500;lastState=null;speedVal;accelVal;powerVal;torqueVal;boostVal;boostCard;speedBarFill;speedBarValue;speedBarMax;maxSpeedKmh;perfGraph;constructor(e,t,i){this.canvas=document.getElementById(e),this.ctx2d=this.canvas.getContext("2d"),this.gaugesEl=document.getElementById(t),this.profile=i,this.maxSpeedKmh=this.calculateMaxSpeed(i),this.buildSpeedBar(),this.buildGauges(),this.setupResize(),this.resizeCanvas(),this.perfGraph=new G("dashboard-container",i),this.drawTachometer(0,0,!1,!1)}setProfile(e){this.profile=e,this.boostCard.style.display=e.turbo?"":"none",this.maxSpeedKmh=this.calculateMaxSpeed(e),this.speedBarMax.textContent=Math.round(this.maxSpeedKmh).toString(),this.perfGraph.setProfile(e),this.lastState=null,this.drawTachometer(0,0,!1,!1)}render(e){this.lastState=e,this.drawTachometer(e.rpm,e.gear,e.isShifting,e.revLimiterActive),this.updateGauges(e),this.updateSpeedBar(e.speedKmh),this.perfGraph.update(e)}calculateMaxSpeed(e){const t=e.peakPower*1e3,i=1.225,a=e.dragCoefficient,s=e.frontalArea,r=e.rollingResistance,l=e.vehicleMass,c=9.81,o=.85;let n=0,d=200;for(let g=0;g<50;g++){const f=(n+d)/2,b=.5*a*i*s*f*f*f,R=r*l*c*f;b+R<t*o?n=f:d=f}const h=(n+d)/2,u=e.gearRatios[e.gearRatios.length-1],m=e.redlineRPM*2*Math.PI*e.wheelRadius/(u*e.finalDrive*60);return Math.min(h,m)*3.6}buildSpeedBar(){const e=this.canvas.parentElement,t=document.createElement("div");t.id="tacho-area";const i=document.createElement("div");i.className="speed-bar-container",i.innerHTML=`
      <div class="speed-bar-max" id="speed-bar-max">${Math.round(this.maxSpeedKmh)}</div>
      <div class="speed-bar-track">
        <div class="speed-bar-fill" id="speed-bar-fill"></div>
      </div>
      <div class="speed-bar-value" id="speed-bar-value">0</div>
      <div class="speed-bar-unit">km/h</div>
    `,e.insertBefore(t,this.canvas),t.appendChild(i),t.appendChild(this.canvas),this.speedBarFill=document.getElementById("speed-bar-fill"),this.speedBarValue=document.getElementById("speed-bar-value"),this.speedBarMax=document.getElementById("speed-bar-max")}updateSpeedBar(e){const t=Math.min(100,e/this.maxSpeedKmh*100);this.speedBarFill.style.height=`${t}%`,this.speedBarValue.textContent=e.toFixed(0)}buildGauges(){this.gaugesEl.innerHTML="";const e=[{id:"speed",label:"Vitesse",unit:"km/h"},{id:"accel",label:"Acc√©l√©ration",unit:"G"},{id:"power",label:"Puissance",unit:"ch"},{id:"torque",label:"Couple",unit:"Nm"},{id:"boost",label:"Boost",unit:"bar"}];for(const t of e){const i=document.createElement("div");i.className="gauge-card",i.id=`gauge-${t.id}`,i.innerHTML=`
        <div class="gauge-label">${t.label}</div>
        <div>
          <span class="gauge-value" id="val-${t.id}">0</span>
          <span class="gauge-unit">${t.unit}</span>
        </div>
      `,this.gaugesEl.appendChild(i)}this.speedVal=document.getElementById("val-speed"),this.accelVal=document.getElementById("val-accel"),this.powerVal=document.getElementById("val-power"),this.torqueVal=document.getElementById("val-torque"),this.boostVal=document.getElementById("val-boost"),this.boostCard=document.getElementById("gauge-boost"),this.boostCard.style.display=this.profile.turbo?"":"none"}updateGauges(e){this.speedVal.textContent=e.speedKmh.toFixed(0),this.accelVal.textContent=e.accelerationG.toFixed(2),this.powerVal.textContent=e.powerHp.toFixed(0),this.torqueVal.textContent=e.torqueNm.toFixed(0),this.profile.turbo&&(this.boostVal.textContent=e.boostBar.toFixed(2))}drawTachometer(e,t,i,a){const s=this.ctx2d,r=this.logicalW,l=this.logicalH,c=r/2,o=l*.52,n=Math.min(r,l)*.36,d=window.devicePixelRatio||1;s.setTransform(d,0,0,d,0,0),s.clearRect(0,0,r,l);const h=5/4*Math.PI,u=-1/4*Math.PI,m=3/2*Math.PI,g=Math.ceil(this.profile.redlineRPM/1e3)*1e3,f=this.profile.redlineRPM;s.beginPath(),s.arc(c,o,n,h,u,!1),s.lineWidth=18,s.strokeStyle="#1e293b",s.stroke();const b=h+f/g*m;s.beginPath(),s.arc(c,o,n,b,u,!1),s.lineWidth=18,s.strokeStyle="rgba(233, 69, 96, 0.3)",s.stroke();const R=Math.min(e,g)/g,w=h+R*m,k=e>=f?"#e94560":"#22c55e";s.beginPath(),s.arc(c,o,n,h,w,!1),s.lineWidth=18,s.strokeStyle=k,s.lineCap="round",s.stroke(),s.lineCap="butt";const S=Math.max(11,n*.1);s.font=`${S}px system-ui`,s.textAlign="center",s.textBaseline="middle";for(let v=0;v<=g;v+=1e3){const T=h+v/g*m,x=Math.cos(T),y=Math.sin(T),$=n-12,_=n+12;s.beginPath(),s.moveTo(c+$*x,o+$*y),s.lineTo(c+_*x,o+_*y),s.lineWidth=2,s.strokeStyle=v>=f?"#e94560":"#556",s.stroke();const q=n+24;s.fillStyle=v>=f?"#e94560":"#889",s.fillText(String(v/1e3),c+q*x,o+q*y)}for(let v=500;v<g;v+=1e3){const T=h+v/g*m,x=Math.cos(T),y=Math.sin(T);s.beginPath(),s.moveTo(c+(n-6)*x,o+(n-6)*y),s.lineTo(c+(n+6)*x,o+(n+6)*y),s.lineWidth=1,s.strokeStyle="#334",s.stroke()}const B=h+Math.min(e,g)/g*m,C=n-22;s.save(),s.shadowColor=k,s.shadowBlur=8,s.beginPath(),s.moveTo(c,o),s.lineTo(c+C*Math.cos(B),o+C*Math.sin(B)),s.lineWidth=3,s.strokeStyle=k,s.stroke(),s.restore(),s.beginPath(),s.arc(c,o,6,0,Math.PI*2),s.fillStyle="#445",s.fill(),s.fillStyle=a?"#e94560":"#eee",s.font=`bold ${Math.max(20,n*.22)}px system-ui`,s.textAlign="center",s.fillText(Math.round(e).toString(),c,o+n*.32),s.font=`${Math.max(10,n*.08)}px system-ui`,s.fillStyle="#667",s.fillText("RPM",c,o+n*.44);const M=t===0?"N":String(t);if(s.font=`bold ${Math.max(24,n*.2)}px system-ui`,s.fillStyle=i?"#eab308":"#22c55e",s.fillText(M,c,o-n*.12),this.lastState&&(this.lastState.launchControlActive&&Math.sin(Date.now()*.01)>0&&(s.fillStyle="#eab308",s.font=`bold ${Math.max(10,n*.09)}px system-ui`,s.textAlign="center",s.fillText("LC",c,o+n*.58)),this.lastState.wheelSlip>.01)){const v=n*1.2,T=6,x=c-v/2,y=o+n*.68;s.fillStyle="#1e293b",s.beginPath(),s.roundRect(x,y,v,T,3),s.fill();const $=Math.min(1,this.lastState.wheelSlip),_=v*$,q=$<.3?"#22c55e":$<.6?"#eab308":"#e94560";s.fillStyle=q,s.beginPath(),s.roundRect(x,y,_,T,3),s.fill(),s.fillStyle="#889",s.font=`${Math.max(8,n*.06)}px system-ui`,s.textAlign="center",s.fillText(`SLIP ${Math.round($*100)}%`,c,y+T+10)}}setupResize(){new ResizeObserver(()=>this.resizeCanvas()).observe(this.canvas.parentElement)}resizeCanvas(){const t=this.canvas.parentElement.getBoundingClientRect(),i=window.devicePixelRatio||1,a=Math.min(t.width-50,600),s=Math.max(180,a*.75);this.logicalW=a,this.logicalH=s,this.canvas.width=a*i,this.canvas.height=s*i,this.canvas.style.width=`${a}px`,this.canvas.style.height=`${s}px`,this.lastState&&this.render(this.lastState)}}class ge{throttle=0;brake=0;keysDown=new Set;_shiftUpPressed=!1;_shiftDownPressed=!1;_transmissionMode="automatic";container;throttleSlider;brakeSlider;throttleValEl;brakeValEl;gearNumberEl;autoBtn;manualBtn;powerBtn;volumeCallback=null;powerCallback=null;inputModeCallback=null;_isEngineOn=!1;_inputMode="keyboard";evBtn;keyboardBtn;evStatusEl;hornClickCallback=null;audioDebugGetter=null;audioDebugIntervalId=0;toneCallback=null;constructor(e){this.container=document.getElementById(e),this.buildUI(),this.setupKeyboard()}get transmissionMode(){return this._transmissionMode}onVolumeChange(e){this.volumeCallback=e}onPowerChange(e){this.powerCallback=e}onInputModeChange(e){this.inputModeCallback=e}setHornClick(e){this.hornClickCallback=e}setAudioDebugGetter(e){this.audioDebugGetter=e,this.audioDebugIntervalId||(this.updateAudioDebug(),this.audioDebugIntervalId=window.setInterval(()=>this.updateAudioDebug(),1500))}onToneChange(e){this.toneCallback=e}get inputMode(){return this._inputMode}setEvStatus(e){if(this.evStatusEl)switch(e.state){case"inactive":this.evStatusEl.innerHTML="";break;case"requesting":this.evStatusEl.innerHTML='<span class="ev-status-dot requesting"></span>En attente GPS...';break;case"active":this.evStatusEl.innerHTML=`<span class="ev-status-dot active"></span>GPS actif (${Math.round(e.accuracy)}m)`;break;case"error":{const t={"permission-denied":"Permission refus√©e",unavailable:"GPS indisponible",timeout:"Timeout GPS","insecure-context":"HTTPS requis"};this.evStatusEl.innerHTML=`<span class="ev-status-dot error"></span>${t[e.reason]}`;break}}}revertToKeyboard(){this._inputMode="keyboard",this.keyboardBtn.classList.add("active"),this.evBtn.classList.remove("active"),this.container.classList.remove("ev-active"),this.setEvStatus({state:"inactive"})}simulatePowerOn(){this._isEngineOn||(this._isEngineOn=!0,this.powerBtn.classList.add("on"),this.powerCallback?.(!0))}updateGearDisplay(e,t){const i=e===0?"N":String(e);this.gearNumberEl.textContent=i,this.gearNumberEl.className=t?"gear-number shifting":"gear-number"}update(e){this.keysDown.has("w")||this.keysDown.has("arrowup")?this.throttle=Math.min(1,this.throttle+3*e):this.throttle=Math.max(0,this.throttle-5*e),this.keysDown.has("s")||this.keysDown.has("arrowdown")?this.brake=Math.min(1,this.brake+3*e):this.brake=Math.max(0,this.brake-5*e);const a=parseFloat(this.throttleSlider.value)/100,s=parseFloat(this.brakeSlider.value)/100,r=Math.max(this.throttle,a),l=Math.max(this.brake,s);this.throttleValEl.textContent=`${Math.round(r*100)}%`,this.brakeValEl.textContent=`${Math.round(l*100)}%`;const c={throttle:r,brake:l,shiftUpPressed:this._shiftUpPressed,shiftDownPressed:this._shiftDownPressed,transmissionMode:this._transmissionMode};return this._shiftUpPressed=!1,this._shiftDownPressed=!1,c}pedalSvg(e){const i=e==="brake"?"#e94560":"#22c55e",a=28,s=14;return`<svg class="pedal-svg" viewBox="0 0 ${a} ${s}" width="${a}" height="${s}" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="1" y="3" width="26" height="8" rx="3" stroke="${i}" stroke-width="1.5" fill="${i}20"/></svg>`}buildUI(){this.container.innerHTML=`
      <div class="control-section power-section">
        <button class="power-btn" id="power-btn" title="D√©marrer / Arr√™ter le moteur">
          <span class="power-icon">‚èª</span>
        </button>
      </div>

      <div class="control-section ev-section">
        <div class="control-label">Mode</div>
        <div class="mode-toggle ev-mode-toggle">
          <button id="mode-keyboard" class="active">Clavier</button>
          <button id="mode-ev">EV+</button>
        </div>
        <div class="ev-status" id="ev-status"></div>
      </div>

      <div class="control-section">
        <div class="control-label">P√©dales</div>
        <div class="pedal-container">
          <div class="pedal-wrapper" data-pedal="brake">
            <div class="pedal-touch" id="brake-touch" title="Frein (toucher / maintenir)">
              <span class="pedal-icon pedal-icon-brake" aria-hidden="true">${this.pedalSvg("brake")}</span>
              <span class="pedal-value" id="brake-val">0%</span>
            </div>
            <input type="range" min="0" max="100" value="0"
                   class="pedal-slider brake" id="brake-slider" orient="vertical">
            <span class="pedal-name">Frein</span>
          </div>
          <div class="pedal-wrapper" data-pedal="throttle">
            <div class="pedal-touch" id="throttle-touch" title="Gaz (toucher / maintenir)">
              <span class="pedal-icon pedal-icon-throttle" aria-hidden="true">${this.pedalSvg("throttle")}</span>
              <span class="pedal-value" id="throttle-val">0%</span>
            </div>
            <input type="range" min="0" max="100" value="0"
                   class="pedal-slider throttle" id="throttle-slider" orient="vertical">
            <span class="pedal-name">Gaz</span>
          </div>
        </div>
      </div>

      <div class="control-section">
        <div class="control-label">Rapport</div>
        <div class="gear-display">
          <button class="gear-btn" id="gear-down">‚óÄ</button>
          <span class="gear-number" id="gear-number">N</span>
          <button class="gear-btn" id="gear-up">‚ñ∂</button>
        </div>
      </div>

      <div class="control-section">
        <div class="control-label">Transmission</div>
        <div class="mode-toggle">
          <button id="mode-auto" class="active">Auto</button>
          <button id="mode-manual">Manuel</button>
        </div>
      </div>

      <div class="control-section">
        <div class="control-label">Volume</div>
        <input type="range" min="0" max="100" value="70"
               class="volume-slider" id="volume-slider">
      </div>

      <div class="control-section">
        <div class="control-label">Son</div>
        <div class="tone-sliders">
          <label class="tone-label"><span>Grave</span><span id="bass-val">12</span> dB</label>
          <input type="range" min="0" max="12" value="12" class="tone-slider" id="bass-slider">
          <label class="tone-label"><span>Reverb</span><span id="reverb-val">33</span> %</label>
          <input type="range" min="0" max="100" value="33" class="tone-slider" id="reverb-slider">
        </div>
      </div>

      <div class="control-section">
        <div class="control-label">Test son</div>
        <button type="button" class="horn-btn" id="horn-btn" title="Tester la sortie audio (klaxon)">
          üé§ Klaxon
        </button>
        <div class="audio-debug" id="audio-debug" aria-live="polite"></div>
      </div>

      <div class="control-section key-hints-compact">
        <span><kbd>W</kbd>/<kbd>S</kbd> Gaz/Frein</span>
        <span><kbd>A</kbd>/<kbd>D</kbd> Rapports</span>
      </div>
    `,this.powerBtn=document.getElementById("power-btn"),this.powerBtn.addEventListener("click",()=>{this._isEngineOn=!this._isEngineOn,this.powerBtn.classList.toggle("on",this._isEngineOn),this.powerCallback?.(this._isEngineOn)}),this.keyboardBtn=document.getElementById("mode-keyboard"),this.evBtn=document.getElementById("mode-ev"),this.evStatusEl=document.getElementById("ev-status"),this.keyboardBtn.addEventListener("click",()=>{this._inputMode!=="keyboard"&&(this._inputMode="keyboard",this.keyboardBtn.classList.add("active"),this.evBtn.classList.remove("active"),this.container.classList.remove("ev-active"),this.inputModeCallback?.("keyboard"))}),this.evBtn.addEventListener("click",()=>{this._inputMode!=="ev-augmented"&&(this._inputMode="ev-augmented",this.evBtn.classList.add("active"),this.keyboardBtn.classList.remove("active"),this.container.classList.add("ev-active"),this.inputModeCallback?.("ev-augmented"))}),this.throttleSlider=document.getElementById("throttle-slider"),this.brakeSlider=document.getElementById("brake-slider"),this.throttleValEl=document.getElementById("throttle-val"),this.brakeValEl=document.getElementById("brake-val"),this.gearNumberEl=document.getElementById("gear-number"),this.setupPedalTouch(),this.autoBtn=document.getElementById("mode-auto"),this.manualBtn=document.getElementById("mode-manual"),document.getElementById("gear-down").addEventListener("click",()=>{this._shiftDownPressed=!0}),document.getElementById("gear-up").addEventListener("click",()=>{this._shiftUpPressed=!0}),this.autoBtn.addEventListener("click",()=>{this._transmissionMode="automatic",this.autoBtn.classList.add("active"),this.manualBtn.classList.remove("active")}),this.manualBtn.addEventListener("click",()=>{this._transmissionMode="manual",this.manualBtn.classList.add("active"),this.autoBtn.classList.remove("active")});const e=document.getElementById("volume-slider");e.addEventListener("input",()=>{this.volumeCallback?.(parseFloat(e.value)/100)});const t=document.getElementById("bass-slider"),i=document.getElementById("reverb-slider"),a=document.getElementById("bass-val"),s=document.getElementById("reverb-val"),r=()=>{const c=parseFloat(t.value),o=parseFloat(i.value)/100;a.textContent=String(c),s.textContent=String(Math.round(o*100)),this.toneCallback?.({bassDb:c,reverbWet:o})};t&&(t.addEventListener("input",r),a.textContent=t.value),i&&(i.addEventListener("input",r),s.textContent=i.value),r();const l=document.getElementById("horn-btn");l&&l.addEventListener("click",()=>{const c=this.hornClickCallback?.();c&&typeof c.then=="function"?c.then(()=>this.updateAudioDebug()):this.updateAudioDebug()})}updateAudioDebug(){const e=document.getElementById("audio-debug");if(!e||!this.audioDebugGetter)return;const t=this.audioDebugGetter(),i=[`Contexte: ${t.contextState}`,t.sampleRate!=null?`Sample rate: ${t.sampleRate} Hz`:"",`Worklet: ${t.workletLoaded?"oui":"non"}`,t.source!=="none"?`Source: ${t.source}`:"",t.canPlay?"Sortie: OK":t.contextState==="suspended"?"Sortie: d√©bloquer (geste utilisateur)":t.contextState==="non initialis√©"?"Sortie: cliquez Klaxon ou Power":"Sortie: ‚Äî"].filter(Boolean);e.textContent=i.join(" ¬∑ "),e.className="audio-debug"+(t.canPlay?" audio-ok":"")}setupPedalTouch(){const e=(a,s)=>{const r=o=>{s.value=String(o),s.dispatchEvent(new Event("input",{bubbles:!0}))},l=o=>{o.preventDefault(),o.currentTarget.setPointerCapture?.(o.pointerId),o.currentTarget.classList.add("pressed"),r(100)},c=o=>{o.currentTarget.classList.remove("pressed"),o.currentTarget.releasePointerCapture?.(o.pointerId),r(0)};a.addEventListener("pointerdown",l),a.addEventListener("pointerup",c),a.addEventListener("pointerleave",c),a.addEventListener("pointercancel",c)},t=document.getElementById("brake-touch"),i=document.getElementById("throttle-touch");e(t,this.brakeSlider),e(i,this.throttleSlider)}setupKeyboard(){window.addEventListener("keydown",e=>{const t=e.key.toLowerCase();this.keysDown.add(t),(t==="a"||t==="arrowleft")&&(this._shiftDownPressed=!0),(t==="d"||t==="arrowright")&&(this._shiftUpPressed=!0)}),window.addEventListener("keyup",e=>{this.keysDown.delete(e.key.toLowerCase())})}}const ve=2*Math.PI;function K(p,e,t){const i=p.gearRatios[t];return e*ve*p.wheelRadius/(i*p.finalDrive*60)*3.6}function U(p){return p.torqueCurve.map(([e,t])=>({rpm:e,kw:F(t,e).kw}))}function W(p){return p.torqueCurve.map(([e,t])=>({rpm:e,nm:t}))}function be(p){const e=Math.max(100,Math.floor((p.redlineRPM-p.idleRPM)/50)),t=[];for(let i=0;i<p.gearRatios.length;i++){const a=[];for(let s=p.idleRPM;s<=p.redlineRPM;s+=e)a.push({rpm:s,kmh:K(p,s,i)});a.length>0&&a[a.length-1].rpm<p.redlineRPM&&a.push({rpm:p.redlineRPM,kmh:K(p,p.redlineRPM,i)}),t.push({gear:i+1,points:a})}return t}const P={power:"#22c55e",torque:"#e94560",grid:"#1e293b",text:"#556",bg:"rgba(15, 21, 41, 0.6)",stroke:"#2a2a4a"},E=["#22c55e","#3b82f6","#eab308","#e94560","#a855f7","#06b6d4","#f97316","#ec4899"],I=["power","torque","power-torque","speed-gears"],Q={power:"Puissance",torque:"Couple","power-torque":"P + C","speed-gears":"Vitesse / rapports"};class we{profile;kind="power";canvas;ctx;resizeObserver=null;labelEl;constructor(e,t,i){this.profile=t,this.labelEl=i??null,this.labelEl&&(this.labelEl.textContent=Q[this.kind]),this.canvas=document.createElement("canvas"),this.canvas.className="detail-chart-canvas",this.canvas.title="Cliquer pour changer de courbe",this.ctx=this.canvas.getContext("2d"),this.canvas.addEventListener("click",()=>{const a=I.indexOf(this.kind),s=I[(a+1)%I.length];this.setChartKind(s)}),e.appendChild(this.canvas),this.resizeObserver=new ResizeObserver(()=>this.resizeAndDraw()),this.resizeObserver.observe(this.canvas.parentElement),this.resizeAndDraw()}setProfile(e){this.profile=e,this.resizeAndDraw()}setChartKind(e){this.kind!==e&&(this.kind=e,this.labelEl&&(this.labelEl.textContent=Q[e]),this.draw())}destroy(){this.resizeObserver?.disconnect(),this.canvas.remove()}resizeAndDraw(){const e=this.canvas.parentElement.getBoundingClientRect(),t=Math.max(200,Math.min(e.width,500)),i=88,a=window.devicePixelRatio||1;this.canvas.width=t*a,this.canvas.height=i*a,this.canvas.style.width=`${t}px`,this.canvas.style.height=`${i}px`,this.draw()}draw(){const e=this.ctx,t=this.canvas.width/(window.devicePixelRatio||1),i=this.canvas.height/(window.devicePixelRatio||1),a=window.devicePixelRatio||1;e.setTransform(a,0,0,a,0,0),e.clearRect(0,0,t,i);const s={top:8,right:8,bottom:20,left:36},r=t-s.left-s.right,l=i-s.top-s.bottom;if(r<10||l<10)return;e.fillStyle=P.bg,e.strokeStyle=P.stroke,e.lineWidth=1,e.beginPath(),e.roundRect(0,0,t,i,6),e.fill(),e.stroke();const{idleRPM:c,redlineRPM:o}=this.profile,n=c,d=o,h=d-n,u=g=>s.left+(g-n)/h*r;e.font="9px system-ui",e.textAlign="center",e.textBaseline="top";const m=h<=4e3?1e3:2e3;for(let g=Math.ceil(n/m)*m;g<=d;g+=m){const f=u(g);e.strokeStyle=P.grid,e.beginPath(),e.moveTo(f,s.top),e.lineTo(f,s.top+l),e.stroke(),e.fillStyle=P.text,e.fillText(`${g/1e3}k`,f,s.top+l+3)}this.kind==="power"?this.drawPowerCurve(s,r,l,u):this.kind==="torque"?this.drawTorqueCurve(s,r,l,u):this.kind==="power-torque"?this.drawPowerTorqueCurve(s,r,l,u):this.drawSpeedGearCurves(s,r,l,u)}drawPowerCurve(e,t,i,a){const s=U(this.profile);if(s.length<2)return;const r=Math.max(...s.map(o=>o.kw),this.profile.peakPower*1.05),l=o=>e.top+i-o/r*i;this.ctx.textAlign="right",this.ctx.textBaseline="middle";const c=r<=150?50:100;for(let o=0;o<=r;o+=c){const n=l(o);this.ctx.strokeStyle=P.grid,this.ctx.beginPath(),this.ctx.moveTo(e.left,n),this.ctx.lineTo(e.left+t,n),this.ctx.stroke(),this.ctx.fillStyle=P.text,this.ctx.fillText(String(o),e.left-4,n)}this.ctx.beginPath(),this.ctx.strokeStyle=P.power,this.ctx.lineWidth=2,this.ctx.lineJoin="round",s.forEach((o,n)=>{n===0?this.ctx.moveTo(a(o.rpm),l(o.kw)):this.ctx.lineTo(a(o.rpm),l(o.kw))}),this.ctx.stroke(),this.ctx.fillStyle=P.text,this.ctx.textAlign="left",this.ctx.fillText("kW",e.left+t+2,e.top+8)}drawTorqueCurve(e,t,i,a){const s=W(this.profile);if(s.length<2)return;const r=Math.max(...s.map(o=>o.nm),this.profile.peakTorque*1.05),l=o=>e.top+i-o/r*i;this.ctx.textAlign="right",this.ctx.textBaseline="middle";const c=r<=300?100:150;for(let o=0;o<=r;o+=c){const n=l(o);this.ctx.strokeStyle=P.grid,this.ctx.beginPath(),this.ctx.moveTo(e.left,n),this.ctx.lineTo(e.left+t,n),this.ctx.stroke(),this.ctx.fillStyle=P.text,this.ctx.fillText(String(o),e.left-4,n)}this.ctx.beginPath(),this.ctx.strokeStyle=P.torque,this.ctx.lineWidth=2,this.ctx.lineJoin="round",s.forEach((o,n)=>{n===0?this.ctx.moveTo(a(o.rpm),l(o.nm)):this.ctx.lineTo(a(o.rpm),l(o.nm))}),this.ctx.stroke(),this.ctx.fillStyle=P.text,this.ctx.textAlign="left",this.ctx.fillText("Nm",e.left+t+2,e.top+8)}drawPowerTorqueCurve(e,t,i,a){const s=U(this.profile),r=W(this.profile);if(s.length<2||r.length<2)return;const l=Math.max(...s.map(h=>h.kw),this.profile.peakPower*1.05),c=Math.max(...r.map(h=>h.nm),this.profile.peakTorque*1.05),o=h=>e.top+i-h/l*i,n=h=>e.top+i-h/c*i;this.ctx.textAlign="right",this.ctx.textBaseline="middle";const d=l<=150?50:100;for(let h=0;h<=l;h+=d){const u=o(h);this.ctx.strokeStyle=P.grid,this.ctx.beginPath(),this.ctx.moveTo(e.left,u),this.ctx.lineTo(e.left+t,u),this.ctx.stroke(),this.ctx.fillStyle=P.text,this.ctx.fillText(String(h),e.left-4,u)}this.ctx.beginPath(),this.ctx.strokeStyle=P.power,this.ctx.lineWidth=2,this.ctx.lineJoin="round",s.forEach((h,u)=>{u===0?this.ctx.moveTo(a(h.rpm),o(h.kw)):this.ctx.lineTo(a(h.rpm),o(h.kw))}),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle=P.torque,this.ctx.setLineDash([4,3]),r.forEach((h,u)=>{u===0?this.ctx.moveTo(a(h.rpm),n(h.nm)):this.ctx.lineTo(a(h.rpm),n(h.nm))}),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.font="9px system-ui",this.ctx.fillStyle=P.power,this.ctx.textAlign="left",this.ctx.fillText("kW",e.left+t+2,e.top+6),this.ctx.fillStyle=P.torque,this.ctx.fillText("Nm",e.left+t+2,e.top+16)}drawSpeedGearCurves(e,t,i,a){const s=be(this.profile);let r=0;s.forEach(o=>{o.points.forEach(n=>{n.kmh>r&&(r=n.kmh)})}),r=Math.ceil(r/20)*20||100;const l=o=>e.top+i-o/r*i;this.ctx.textAlign="right",this.ctx.textBaseline="middle";const c=r<=150?50:100;for(let o=0;o<=r;o+=c){const n=l(o);this.ctx.strokeStyle=P.grid,this.ctx.beginPath(),this.ctx.moveTo(e.left,n),this.ctx.lineTo(e.left+t,n),this.ctx.stroke(),this.ctx.fillStyle=P.text,this.ctx.fillText(String(o),e.left-4,n)}s.forEach(({points:o},n)=>{const d=E[n%E.length];this.ctx.beginPath(),this.ctx.strokeStyle=d,this.ctx.lineWidth=1.5,this.ctx.lineJoin="round",o.forEach((h,u)=>{u===0?this.ctx.moveTo(a(h.rpm),l(h.kmh)):this.ctx.lineTo(a(h.rpm),l(h.kmh))}),this.ctx.stroke()}),this.ctx.font="8px system-ui",this.ctx.textAlign="left",s.forEach(({gear:o},n)=>{const d=E[n%E.length];this.ctx.fillStyle=d,this.ctx.fillText(`${o}`,e.left+t+2,e.top+6+n*10)})}}class Me{container;groups;activeId;activeProfile;onSelect;viewMode="carousel";isCompact=!1;detailCharts=null;constructor(e,t,i,a){this.container=document.getElementById(e),this.groups=t,this.activeId=i.id,this.activeProfile=i,this.onSelect=a,this.render()}setCompact(e){this.isCompact!==e&&(this.isCompact=e,this.render())}render(){this.detailCharts?.destroy(),this.detailCharts=null,this.container.innerHTML="",this.container.className=this.isCompact?"vehicle-gallery compact":"vehicle-gallery",this.viewMode==="carousel"?this.renderCarousel():this.renderDetail()}renderCarousel(){const e=document.createElement("div");e.className=this.isCompact?"gallery-carousel compact":"gallery-carousel";for(const t of this.groups)for(const i of t.profiles){const a=document.createElement("div");if(a.className=i.id===this.activeId?"vehicle-card active":"vehicle-card",this.isCompact)a.innerHTML=`
            <img src="${i.imageUrl||""}" alt="${i.name}" loading="lazy" />
            <span class="vehicle-card-name-compact">${i.name.split(" ")[0]}</span>
          `;else{const r=i.peakPower,l=i.peakTorque;a.innerHTML=`
            <img src="${i.imageUrl||""}" alt="${i.name}" loading="lazy" />
            <div class="vehicle-card-info">
              <div class="vehicle-card-name">${i.name}</div>
              <div class="vehicle-card-stats">${r} kW ¬∑ ${l} Nm ¬∑ ${i.displacement}cc</div>
            </div>
          `}a.querySelector("img")?.addEventListener("click",r=>{r.stopPropagation(),i.id!==this.activeId&&(this.activeId=i.id,this.activeProfile=i,this.onSelect(i)),this.viewMode="detail",this.render()}),a.addEventListener("click",r=>{r.target.closest("img")||i.id!==this.activeId&&(this.activeId=i.id,this.activeProfile=i,this.onSelect(i),this.render())}),e.appendChild(a)}this.container.appendChild(e)}renderDetail(){const e=this.activeProfile,t=document.createElement("div");t.className="vehicle-detail-panel";const i=e.gearRatios.length,a=e.aspiration==="turbo"?"Turbo":e.aspiration==="turbo-diesel"?"Turbo Diesel":"Atmosph√©rique",s=e.driveType==="fwd"?"Traction avant":e.driveType==="awd"?"Int√©grale":e.driveType==="rwd"?"Traction arri√®re":"‚Äî";t.innerHTML=`
      <div class="detail-content">
        <div class="detail-photo" role="button" tabindex="0" aria-label="Retour √† la galerie">
          <img src="${e.imageUrl||""}" alt="${e.name}" />
        </div>
        <div class="detail-right mode-specs">
          <div class="detail-header">
            <h3 class="detail-title">${e.name}</h3>
            <div class="detail-toggle">
              <button type="button" class="detail-toggle-btn active" data-mode="specs">Fiche</button>
              <button type="button" class="detail-toggle-btn" data-mode="chart">Courbes</button>
            </div>
            <span class="detail-chart-name" aria-hidden="true"></span>
          </div>
          <div class="detail-body">
            <div class="detail-specs">
            <dl class="detail-grid">
              <dt>Type</dt><dd>${e.type}</dd>
              <dt>Cylindr√©e</dt><dd>${e.displacement} cc</dd>
              <dt>Cylindres</dt><dd>${e.cylinders}</dd>
              <dt>Aspiration</dt><dd>${a}</dd>
              <dt>Traction</dt><dd>${s}</dd>
              <dt>Puissance</dt><dd>${e.peakPower} kW @ ${e.peakPowerRPM}</dd>
              <dt>Couple</dt><dd>${e.peakTorque} Nm @ ${e.peakTorqueRPM}</dd>
              <dt>Redline</dt><dd>${e.redlineRPM} RPM</dd>
              <dt>Vitesses</dt><dd>${i}</dd>
              <dt>Masse</dt><dd>${e.vehicleMass} kg</dd>
              <dt>P/M</dt><dd>${(e.peakPower/e.vehicleMass*1e3).toFixed(1)} W/kg</dd>
            </dl>
            </div>
            <div class="detail-chart-wrap"></div>
          </div>
        </div>
      </div>
    `;const r=t.querySelector(".detail-photo");r?.addEventListener("click",()=>{this.viewMode="carousel",this.render()}),r?.addEventListener("keydown",d=>{const h=d;(h.key==="Enter"||h.key===" ")&&(d.preventDefault(),this.viewMode="carousel",this.render())});const l=t.querySelector(".detail-right"),c=t.querySelectorAll(".detail-toggle-btn");l&&c.length&&c.forEach(d=>{d.addEventListener("click",()=>{const h=d.dataset.mode==="chart"?"chart":"specs";l.classList.toggle("mode-specs",h==="specs"),l.classList.toggle("mode-chart",h==="chart"),c.forEach(u=>u.classList.toggle("active",u===d))})});const o=t.querySelector(".detail-chart-wrap"),n=t.querySelector(".detail-chart-name");o&&(this.detailCharts=new we(o,this.activeProfile,n)),this.container.appendChild(t)}}const Pe="honda-k20a",Re="Honda K20A VTEC",Te="https://upload.wikimedia.org/wikipedia/commons/thumb/9/97/Honda_FK8.jpg/300px-Honda_FK8.jpg",xe="inline-4",ye=1998,ke=4,$e="na",Se="fwd",Be=800,Ce=8600,_e=206,qe=7e3,Ae=162,Ee=8e3,De=[[800,50],[1e3,90],[2e3,130],[3e3,155],[4e3,175],[5e3,190],[5500,185],[6e3,180],[6500,190],[7e3,206],[7500,200],[8e3,188],[8600,160]],Ge=[1,3,4,2],Le=[3.267,2.105,1.481,1.161,.971,.811],Ie=4.764,Oe=.316,Fe={type:"sport",lowpassBaseFreq:1500,lowpassRpmScale:.3,lowpassQ:1.5,resonances:[{freq:600,Q:5,gainDB:8},{freq:1800,Q:3,gainDB:4},{freq:3500,Q:2,gainDB:3}]},He={numHarmonics:24,spectralRolloff:.9,firingHarmonicBoost:3,loadBrightness:.7},Ve=1200,Ne=.31,Ke=2,Ue=.012,We={id:Pe,name:Re,imageUrl:Te,type:xe,displacement:ye,cylinders:ke,aspiration:$e,driveType:Se,idleRPM:Be,redlineRPM:Ce,peakTorque:_e,peakTorqueRPM:qe,peakPower:Ae,peakPowerRPM:Ee,torqueCurve:De,firingOrder:Ge,gearRatios:Le,finalDrive:Ie,wheelRadius:Oe,exhaustConfig:Fe,harmonicProfile:He,vehicleMass:Ve,dragCoefficient:Ne,frontalArea:Ke,rollingResistance:Ue},Qe="toyota-2gr-fe",ze="Toyota 2GR-FE V6",je="https://upload.wikimedia.org/wikipedia/commons/thumb/6/65/2021_Toyota_Camry_TRD_V6.jpg/300px-2021_Toyota_Camry_TRD_V6.jpg",Ye="v6",Je=3456,Xe=6,Ze="na",et="fwd",tt=650,st=6500,it=336,at=4700,ot=200,nt=6200,rt=[[650,80],[1e3,150],[1500,220],[2e3,270],[2500,300],[3e3,320],[3500,330],[4e3,334],[4700,336],[5e3,330],[5500,310],[6e3,280],[6500,240]],lt=[1,2,3,4,5,6],ct=[3.52,2.042,1.4,1,.716,.586],ht=3.933,dt=.33,ut={type:"stock",lowpassBaseFreq:900,lowpassRpmScale:.15,lowpassQ:.8,resonances:[{freq:450,Q:3,gainDB:5},{freq:1300,Q:2,gainDB:3}]},pt={numHarmonics:24,spectralRolloff:1,firingHarmonicBoost:3.5,loadBrightness:.6},mt=1600,ft=.3,gt=2.3,vt=.012,bt={id:Qe,name:ze,imageUrl:je,type:Ye,displacement:Je,cylinders:Xe,aspiration:Ze,driveType:et,idleRPM:tt,redlineRPM:st,peakTorque:it,peakTorqueRPM:at,peakPower:ot,peakPowerRPM:nt,torqueCurve:rt,firingOrder:lt,gearRatios:ct,finalDrive:ht,wheelRadius:dt,exhaustConfig:ut,harmonicProfile:pt,vehicleMass:mt,dragCoefficient:ft,frontalArea:gt,rollingResistance:vt},wt="ford-coyote-50",Mt="Ford Coyote 5.0 V8",Pt="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/2018_Ford_Mustang_GT_5.0_Front.jpg/300px-2018_Ford_Mustang_GT_5.0_Front.jpg",Rt="v8-crossplane",Tt=5035,xt=8,yt="na",kt="rwd",$t=700,St=7500,Bt=569,Ct=4600,_t=343,qt=7e3,At=[[700,100],[1e3,200],[1500,320],[2e3,400],[2500,460],[3e3,510],[3500,545],[4e3,560],[4600,569],[5e3,560],[5500,540],[6e3,510],[6500,470],[7e3,420],[7500,360]],Et=[1,3,7,2,6,5,4,8],Dt=[3.657,2.18,1.452,1,.686,.58],Gt=3.73,Lt=.34,It={type:"sport",lowpassBaseFreq:1800,lowpassRpmScale:.35,lowpassQ:1.2,resonances:[{freq:350,Q:6,gainDB:10},{freq:800,Q:4,gainDB:6},{freq:2200,Q:2,gainDB:3}]},Ot={numHarmonics:24,spectralRolloff:.8,firingHarmonicBoost:2.5,loadBrightness:.8},Ft=1700,Ht=.33,Vt=2.2,Nt=.013,Kt={id:wt,name:Mt,imageUrl:Pt,type:Rt,displacement:Tt,cylinders:xt,aspiration:yt,driveType:kt,idleRPM:$t,redlineRPM:St,peakTorque:Bt,peakTorqueRPM:Ct,peakPower:_t,peakPowerRPM:qt,torqueCurve:At,firingOrder:Et,gearRatios:Dt,finalDrive:Gt,wheelRadius:Lt,exhaustConfig:It,harmonicProfile:Ot,vehicleMass:Ft,dragCoefficient:Ht,frontalArea:Vt,rollingResistance:Nt},Ut="bmw-b58",Wt="BMW B58 Turbo I6",Qt="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2d/BMW_M340i_%28G20%29_Washington_DC_Metro_Area%2C_USA.jpg/300px-BMW_M340i_%28G20%29_Washington_DC_Metro_Area%2C_USA.jpg",zt="inline-6",jt=2998,Yt=6,Jt="turbo",Xt="rwd",Zt=700,es=7e3,ts=500,ss=1600,is=285,as=5500,os=[[700,100],[1e3,250],[1200,350],[1400,430],[1600,500],[2e3,500],[2500,500],[3e3,500],[3500,500],[4e3,500],[4500,500],[5e3,480],[5500,440],[6e3,390],[6500,350],[7e3,300]],ns=[1,5,3,6,2,4],rs=[4.714,3.143,2.106,1.667,1.285,1,.839,.667],ls=3.154,cs=.33,hs={type:"sport",lowpassBaseFreq:1400,lowpassRpmScale:.25,lowpassQ:1.3,resonances:[{freq:500,Q:5,gainDB:7},{freq:1500,Q:3,gainDB:5},{freq:3e3,Q:2,gainDB:3}]},ds={numHarmonics:24,spectralRolloff:1,firingHarmonicBoost:3.5,loadBrightness:.65},us={maxBoostBar:1.2,spoolTimeSec:.5,boostThresholdRPM:1500,hasBOV:!0},ps=1600,ms=.29,fs=2.2,gs=.011,vs={id:Ut,name:Wt,imageUrl:Qt,type:zt,displacement:jt,cylinders:Yt,aspiration:Jt,driveType:Xt,idleRPM:Zt,redlineRPM:es,peakTorque:ts,peakTorqueRPM:ss,peakPower:is,peakPowerRPM:as,torqueCurve:os,firingOrder:ns,gearRatios:rs,finalDrive:ls,wheelRadius:cs,exhaustConfig:hs,harmonicProfile:ds,turbo:us,vehicleMass:ps,dragCoefficient:ms,frontalArea:fs,rollingResistance:gs},bs="ferrari-f136",ws="Ferrari F136 V8",Ms="https://upload.wikimedia.org/wikipedia/commons/thumb/e/ea/White_Ferrari_458_Italia_front.JPG/300px-White_Ferrari_458_Italia_front.JPG",Ps="v8-flatplane",Rs=4497,Ts=8,xs="na",ys="rwd",ks=1e3,$s=9e3,Ss=540,Bs=6e3,Cs=419,_s=9e3,qs=[[1e3,100],[1500,180],[2e3,260],[2500,320],[3e3,380],[3500,420],[4e3,450],[4500,475],[5e3,500],[5500,525],[6e3,540],[6500,535],[7e3,520],[7500,495],[8e3,465],[8500,430],[9e3,390]],As=[1,8,2,7,4,5,3,6],Es=[3.08,2.19,1.63,1.29,1.03,.84,.64],Ds=4.44,Gs=.33,Ls={type:"straight-pipe",lowpassBaseFreq:3500,lowpassRpmScale:.4,lowpassQ:.7,resonances:[{freq:400,Q:7,gainDB:9},{freq:1100,Q:5,gainDB:6},{freq:3200,Q:3,gainDB:4}]},Is={numHarmonics:28,spectralRolloff:.85,firingHarmonicBoost:3.5,loadBrightness:.75},Os=1485,Fs=.33,Hs=2,Vs=.011,Ns={id:bs,name:ws,imageUrl:Ms,type:Ps,displacement:Rs,cylinders:Ts,aspiration:xs,driveType:ys,idleRPM:ks,redlineRPM:$s,peakTorque:Ss,peakTorqueRPM:Bs,peakPower:Cs,peakPowerRPM:_s,torqueCurve:qs,firingOrder:As,gearRatios:Es,finalDrive:Ds,wheelRadius:Gs,exhaustConfig:Ls,harmonicProfile:Is,vehicleMass:Os,dragCoefficient:Fs,frontalArea:Hs,rollingResistance:Vs},Ks="vw-20-tdi",Us="VW 2.0 TDI Diesel",Ws="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3e/VW_Golf_VII_Variant_Highline_2.0_TDI.JPG/300px-VW_Golf_VII_Variant_Highline_2.0_TDI.JPG",Qs="inline-4",zs=1968,js=4,Ys="turbo-diesel",Js="fwd",Xs=800,Zs=5e3,ei=320,ti=1750,si=103,ii=4e3,ai=[[800,80],[1e3,150],[1200,220],[1500,280],[1750,320],[2e3,320],[2500,320],[3e3,290],[3500,250],[4e3,210],[4500,170],[5e3,120]],oi=[1,3,4,2],ni=[3.778,2.118,1.36,.971,.756,.635],ri=3.45,li=.32,ci={type:"stock",lowpassBaseFreq:700,lowpassRpmScale:.12,lowpassQ:.6,resonances:[{freq:300,Q:3,gainDB:4},{freq:900,Q:2,gainDB:2}]},hi={numHarmonics:20,spectralRolloff:1.2,firingHarmonicBoost:2.5,loadBrightness:.5},di={maxBoostBar:1.8,spoolTimeSec:.8,boostThresholdRPM:1200,hasBOV:!1},ui=1450,pi=.3,mi=2.2,fi=.012,gi={id:Ks,name:Us,imageUrl:Ws,type:Qs,displacement:zs,cylinders:js,aspiration:Ys,driveType:Js,idleRPM:Xs,redlineRPM:Zs,peakTorque:ei,peakTorqueRPM:ti,peakPower:si,peakPowerRPM:ii,torqueCurve:ai,firingOrder:oi,gearRatios:ni,finalDrive:ri,wheelRadius:li,exhaustConfig:ci,harmonicProfile:hi,turbo:di,vehicleMass:ui,dragCoefficient:pi,frontalArea:mi,rollingResistance:fi},vi="bugatti-chiron",bi="Bugatti Chiron W16",wi="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6f/Bugatti_Chiron%2C_GIMS_2018%2C_Le_Grand-Saconnex_%281X7A1765%29.jpg/300px-Bugatti_Chiron%2C_GIMS_2018%2C_Le_Grand-Saconnex_%281X7A1765%29.jpg",Mi="w16",Pi=7993,Ri=16,Ti="turbo",xi="awd",yi=700,ki=6900,$i=1600,Si=2e3,Bi=1103,Ci=6700,_i=[[700,300],[1e3,600],[1500,1200],[2e3,1600],[2500,1600],[3e3,1600],[3500,1600],[4e3,1600],[4500,1550],[5e3,1500],[5500,1400],[6e3,1300],[6500,1200],[6900,1100]],qi=[1,12,7,4,15,6,13,8,3,16,11,2,9,14,5,10],Ai=[3.846,2.476,1.786,1.391,1.121,.943,.794],Ei=2.235,Di=.36,Gi={type:"sport",lowpassBaseFreq:1600,lowpassRpmScale:.3,lowpassQ:1,resonances:[{freq:400,Q:4,gainDB:8},{freq:1200,Q:3,gainDB:5},{freq:2800,Q:2,gainDB:3}]},Li={numHarmonics:28,spectralRolloff:1.1,firingHarmonicBoost:2,loadBrightness:.6},Ii={maxBoostBar:1.6,spoolTimeSec:.6,boostThresholdRPM:1500,hasBOV:!0},Oi=1995,Fi=.35,Hi=2.07,Vi=.01,Ni={id:vi,name:bi,imageUrl:wi,type:Mi,displacement:Pi,cylinders:Ri,aspiration:Ti,driveType:xi,idleRPM:yi,redlineRPM:ki,peakTorque:$i,peakTorqueRPM:Si,peakPower:Bi,peakPowerRPM:Ci,torqueCurve:_i,firingOrder:qi,gearRatios:Ai,finalDrive:Ei,wheelRadius:Di,exhaustConfig:Gi,harmonicProfile:Li,turbo:Ii,vehicleMass:Oi,dragCoefficient:Fi,frontalArea:Hi,rollingResistance:Vi},Ki="bugatti-chiron-ss300",Ui="Bugatti Chiron Super Sport 300+",Wi="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4b/2019_Bugatti_Chiron_Super_Sport_300%2B_8.0_Front.jpg/300px-2019_Bugatti_Chiron_Super_Sport_300%2B_8.0_Front.jpg",Qi="w16",zi=7993,ji=16,Yi="turbo",Ji="awd",Xi=700,Zi=7100,ea=1600,ta=2e3,sa=1193,ia=6700,aa=[[700,350],[1e3,700],[1500,1400],[2e3,1600],[2500,1600],[3e3,1600],[3500,1600],[4e3,1600],[4500,1580],[5e3,1540],[5500,1480],[6e3,1400],[6500,1280],[7100,1150]],oa=[1,12,7,4,15,6,13,8,3,16,11,2,9,14,5,10],na=[3.64,2.35,1.69,1.32,1.06,.89,.75],ra=2.235,la=.36,ca={type:"straight-pipe",lowpassBaseFreq:1800,lowpassRpmScale:.32,lowpassQ:1,resonances:[{freq:400,Q:4,gainDB:9},{freq:1200,Q:3,gainDB:6},{freq:3e3,Q:2,gainDB:4}]},ha={numHarmonics:28,spectralRolloff:1.05,firingHarmonicBoost:2.2,loadBrightness:.65},da={maxBoostBar:1.8,spoolTimeSec:.5,boostThresholdRPM:1400,hasBOV:!0},ua=1995,pa=.33,ma=2.07,fa=.01,ga={id:Ki,name:Ui,imageUrl:Wi,type:Qi,displacement:zi,cylinders:ji,aspiration:Yi,driveType:Ji,idleRPM:Xi,redlineRPM:Zi,peakTorque:ea,peakTorqueRPM:ta,peakPower:sa,peakPowerRPM:ia,torqueCurve:aa,firingOrder:oa,gearRatios:na,finalDrive:ra,wheelRadius:la,exhaustConfig:ca,harmonicProfile:ha,turbo:da,vehicleMass:ua,dragCoefficient:pa,frontalArea:ma,rollingResistance:fa},va="lamborghini-aventador",ba="Lamborghini Aventador V12",wa="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c9/Lamborghini_Aventador_LP700-4.jpg/300px-Lamborghini_Aventador_LP700-4.jpg",Ma="v12",Pa=6498,Ra=12,Ta="na",xa="awd",ya=800,ka=8500,$a=690,Sa=5500,Ba=566,Ca=8250,_a=[[800,200],[1500,350],[2500,450],[3500,550],[4500,620],[5500,690],[6e3,680],[6500,660],[7e3,640],[7500,610],[8e3,570],[8500,520]],qa=[1,7,5,11,3,9,6,12,2,8,4,10],Aa=[3.91,2.56,1.81,1.39,1.08,.88,.73],Ea=3.21,Da=.35,Ga={type:"straight-pipe",lowpassBaseFreq:3200,lowpassRpmScale:.4,lowpassQ:.8,resonances:[{freq:450,Q:6,gainDB:9},{freq:1100,Q:4,gainDB:6},{freq:2800,Q:3,gainDB:4}]},La={numHarmonics:28,spectralRolloff:.85,firingHarmonicBoost:3,loadBrightness:.7},Ia=1575,Oa=.33,Fa=2.12,Ha=.01,Va={id:va,name:ba,imageUrl:wa,type:Ma,displacement:Pa,cylinders:Ra,aspiration:Ta,driveType:xa,idleRPM:ya,redlineRPM:ka,peakTorque:$a,peakTorqueRPM:Sa,peakPower:Ba,peakPowerRPM:Ca,torqueCurve:_a,firingOrder:qa,gearRatios:Aa,finalDrive:Ea,wheelRadius:Da,exhaustConfig:Ga,harmonicProfile:La,vehicleMass:Ia,dragCoefficient:Oa,frontalArea:Fa,rollingResistance:Ha},Na="porsche-911-gt3",Ka="Porsche 911 GT3 Flat-6",Ua="https://upload.wikimedia.org/wikipedia/commons/thumb/1/18/Porsche_911_GT3_4.0_%28992%29_1X7A7256.jpg/300px-Porsche_911_GT3_4.0_%28992%29_1X7A7256.jpg",Wa="flat-6",Qa=3996,za=6,ja="na",Ya="rwd",Ja=900,Xa=9e3,Za=470,eo=6100,to=375,so=8400,io=[[900,140],[1500,220],[2500,310],[3500,380],[4500,430],[5e3,450],[5500,460],[6100,470],[6500,465],[7e3,455],[7500,440],[8e3,420],[8400,400],[9e3,370]],ao=[1,6,2,4,3,5],oo=[3.31,2.16,1.61,1.27,1.03,.85,.71],no=3.44,ro=.33,lo={type:"sport",lowpassBaseFreq:2800,lowpassRpmScale:.5,lowpassQ:.9,resonances:[{freq:500,Q:5,gainDB:8},{freq:1400,Q:4,gainDB:5},{freq:3500,Q:2,gainDB:3}]},co={numHarmonics:26,spectralRolloff:.85,firingHarmonicBoost:3.5,loadBrightness:.75},ho=1418,uo=.34,po=2,mo=.01,fo={id:Na,name:Ka,imageUrl:Ua,type:Wa,displacement:Qa,cylinders:za,aspiration:ja,driveType:Ya,idleRPM:Ja,redlineRPM:Xa,peakTorque:Za,peakTorqueRPM:eo,peakPower:to,peakPowerRPM:so,torqueCurve:io,firingOrder:ao,gearRatios:oo,finalDrive:no,wheelRadius:ro,exhaustConfig:lo,harmonicProfile:co,vehicleMass:ho,dragCoefficient:uo,frontalArea:po,rollingResistance:mo},go="f1-v6-turbo-hybrid",vo="F1 V6 Turbo Hybrid (2022)",bo="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2b/2022_F1_car_at_Belgian_GP.jpg/300px-2022_F1_car_at_Belgian_GP.jpg",wo="v6",Mo=1600,Po=6,Ro="turbo",To="rwd",xo=3500,yo=15e3,ko=500,$o=9500,So=582,Bo=12e3,Co=[[3500,320],[4e3,380],[5e3,440],[6e3,470],[7e3,490],[8e3,500],[9e3,500],[9500,500],[1e4,495],[11e3,480],[12e3,460],[13e3,430],[14e3,390],[15e3,350]],_o=[1,6,2,4,3,5],qo=[3.5,2.92,2.42,2.08,1.82,1.58,1.38,1.22],Ao=3.7,Eo=.33,Do={type:"straight-pipe",lowpassBaseFreq:4500,lowpassRpmScale:.35,lowpassQ:.8,resonances:[{freq:600,Q:6,gainDB:8},{freq:1800,Q:4,gainDB:5},{freq:4e3,Q:2.5,gainDB:3}]},Go={numHarmonics:24,spectralRolloff:.9,firingHarmonicBoost:3.2,loadBrightness:.85},Lo={maxBoostBar:3.8,spoolTimeSec:.18,boostThresholdRPM:3600,hasBOV:!0},Io=798,Oo=.9,Fo=1.5,Ho=.008,Vo={id:go,name:vo,imageUrl:bo,type:wo,displacement:Mo,cylinders:Po,aspiration:Ro,driveType:To,idleRPM:xo,redlineRPM:yo,peakTorque:ko,peakTorqueRPM:$o,peakPower:So,peakPowerRPM:Bo,torqueCurve:Co,firingOrder:_o,gearRatios:qo,finalDrive:Ao,wheelRadius:Eo,exhaustConfig:Do,harmonicProfile:Go,turbo:Lo,vehicleMass:Io,dragCoefficient:Oo,frontalArea:Fo,rollingResistance:Ho},No="ducati-panigale-v4",Ko="Ducati Panigale V4",Uo="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e1/Ducati_Panigale_V4_Las_Vegas.jpg/300px-Ducati_Panigale_V4_Las_Vegas.jpg",Wo="v4",Qo=1103,zo=4,jo="na",Yo="rwd",Jo=1200,Xo=14500,Zo=124,en=1e4,tn=157,sn=13e3,an=[[1200,35],[2e3,50],[3e3,65],[4e3,78],[5e3,88],[6e3,97],[7e3,105],[8e3,112],[9e3,119],[1e4,124],[11e3,122],[12e3,118],[13e3,112],[14e3,100],[14500,90]],on=[1,3,2,4],nn=[2.93,2.15,1.76,1.52,1.36,1.24],rn=2.93,ln=.31,cn={type:"sport",lowpassBaseFreq:2400,lowpassRpmScale:.6,lowpassQ:.8,resonances:[{freq:600,Q:5,gainDB:8},{freq:1600,Q:4,gainDB:5},{freq:4e3,Q:2,gainDB:3}]},hn={numHarmonics:24,spectralRolloff:.8,firingHarmonicBoost:3,loadBrightness:.8},dn=198,un=.6,pn=.55,mn=.012,fn={id:No,name:Ko,imageUrl:Uo,type:Wo,displacement:Qo,cylinders:zo,aspiration:jo,driveType:Yo,idleRPM:Jo,redlineRPM:Xo,peakTorque:Zo,peakTorqueRPM:en,peakPower:tn,peakPowerRPM:sn,torqueCurve:an,firingOrder:on,gearRatios:nn,finalDrive:rn,wheelRadius:ln,exhaustConfig:cn,harmonicProfile:hn,vehicleMass:dn,dragCoefficient:un,frontalArea:pn,rollingResistance:mn},gn="yamaha-r1",vn="Yamaha YZF-R1",bn="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e1/2015_Yamaha_YZF-R1.JPG/300px-2015_Yamaha_YZF-R1.JPG",wn="inline-4",Mn=998,Pn=4,Rn="na",Tn="rwd",xn=1100,yn=13500,kn=113,$n=11500,Sn=147,Bn=13e3,Cn=[[1100,30],[2e3,42],[3e3,55],[4e3,65],[5e3,75],[6e3,83],[7e3,90],[8e3,96],[9e3,102],[1e4,107],[11e3,111],[11500,113],[12e3,110],[13e3,105],[13500,95]],_n=[1,3,2,4],qn=[2.85,2.06,1.69,1.45,1.29,1.16],An=2.82,En=.31,Dn={type:"sport",lowpassBaseFreq:2200,lowpassRpmScale:.55,lowpassQ:.8,resonances:[{freq:550,Q:5,gainDB:7},{freq:1500,Q:3,gainDB:5},{freq:3800,Q:2,gainDB:3}]},Gn={numHarmonics:24,spectralRolloff:.85,firingHarmonicBoost:3,loadBrightness:.75},Ln=201,In=.58,On=.55,Fn=.012,Hn={id:gn,name:vn,imageUrl:bn,type:wn,displacement:Mn,cylinders:Pn,aspiration:Rn,driveType:Tn,idleRPM:xn,redlineRPM:yn,peakTorque:kn,peakTorqueRPM:$n,peakPower:Sn,peakPowerRPM:Bn,torqueCurve:Cn,firingOrder:_n,gearRatios:qn,finalDrive:An,wheelRadius:En,exhaustConfig:Dn,harmonicProfile:Gn,vehicleMass:Ln,dragCoefficient:In,frontalArea:On,rollingResistance:Fn},Vn="harley-davidson-vtwin",Nn="Harley-Davidson V-Twin",Kn="https://upload.wikimedia.org/wikipedia/commons/thumb/9/99/Harley_Davidson_Fat_Boy_2018_FLFBS.jpg/300px-Harley_Davidson_Fat_Boy_2018_FLFBS.jpg",Un="v-twin",Wn=1868,Qn=2,zn="na",jn="rwd",Yn=800,Jn=5500,Xn=150,Zn=3e3,er=65,tr=4800,sr=[[800,50],[1e3,70],[1500,100],[2e3,125],[2500,140],[3e3,150],[3500,148],[4e3,142],[4500,132],[4800,120],[5e3,110],[5500,95]],ir=[1,2],ar=[3.36,2.3,1.65,1.29,1,.84],or=2.41,nr=.33,rr={type:"straight-pipe",lowpassBaseFreq:1200,lowpassRpmScale:.35,lowpassQ:.7,resonances:[{freq:250,Q:4,gainDB:10},{freq:700,Q:3,gainDB:6},{freq:1500,Q:2,gainDB:3}]},lr={numHarmonics:20,spectralRolloff:.7,firingHarmonicBoost:4,loadBrightness:.6},cr=320,hr=.65,dr=.7,ur=.013,pr={id:Vn,name:Nn,imageUrl:Kn,type:Un,displacement:Wn,cylinders:Qn,aspiration:zn,driveType:jn,idleRPM:Yn,redlineRPM:Jn,peakTorque:Xn,peakTorqueRPM:Zn,peakPower:er,peakPowerRPM:tr,torqueCurve:sr,firingOrder:ir,gearRatios:ar,finalDrive:or,wheelRadius:nr,exhaustConfig:rr,harmonicProfile:lr,vehicleMass:cr,dragCoefficient:hr,frontalArea:dr,rollingResistance:ur},Z=[{label:"Cars",profiles:[We,bt,Kt,vs,Ns,gi]},{label:"Supercars",profiles:[Ni,ga,Va,fo]},{label:"Record / F1",profiles:[Vo]},{label:"Motos",profiles:[fn,Hn,pr]}];function mr(){return Z}function fr(){return Z[0].profiles[0]}const z=.3,j=3e3;class gr{gpsWatchId=null;lastGpsSpeed=0;lastGpsTimestamp=0;prevGpsSpeed=0;prevGpsTimestamp=0;gpsAcceleration=0;gpsAccuracy=1/0;interpolatedSpeed=0;accelSmoothed=0;hasAccelerometer=!1;deviceMotionHandler=null;statusCallback=null;_isActive=!1;get isActive(){return this._isActive}onStatusChange(e){this.statusCallback=e}async start(){if(!window.isSecureContext){const e={state:"error",reason:"insecure-context"};return this.statusCallback?.(e),e}if(!navigator.geolocation){const e={state:"error",reason:"unavailable"};return this.statusCallback?.(e),e}return this.statusCallback?.({state:"requesting"}),await this.requestAccelerometerPermission(),new Promise(e=>{this.gpsWatchId=navigator.geolocation.watchPosition(t=>{if(this.handleGpsUpdate(t),!this._isActive){this._isActive=!0;const i={state:"active",accuracy:t.coords.accuracy};this.statusCallback?.(i),e(i)}},t=>{if(!this._isActive){const a={state:"error",reason:t.code===1?"permission-denied":t.code===3?"timeout":"unavailable"};this.statusCallback?.(a),e(a)}},{enableHighAccuracy:!0,maximumAge:0,timeout:5e3}),this.startAccelerometer()})}stop(){this.gpsWatchId!==null&&(navigator.geolocation.clearWatch(this.gpsWatchId),this.gpsWatchId=null),this.deviceMotionHandler&&(window.removeEventListener("devicemotion",this.deviceMotionHandler),this.deviceMotionHandler=null),this._isActive=!1,this.interpolatedSpeed=0,this.lastGpsSpeed=0,this.accelSmoothed=0,this.gpsAcceleration=0,this.statusCallback?.({state:"inactive"})}update(e){const i=performance.now()-this.lastGpsTimestamp;return i>j&&this.lastGpsTimestamp>0||this.hasAccelerometer&&this.lastGpsTimestamp>0&&(this.interpolatedSpeed=Math.max(0,this.interpolatedSpeed+this.accelSmoothed*e)),{speedMs:this.interpolatedSpeed,accelerationMs2:this.lastGpsTimestamp>0?this.gpsAcceleration:0,gpsAccuracy:this.gpsAccuracy,isGpsActive:this._isActive&&i<j}}handleGpsUpdate(e){const t=e.coords.speed??0,i=performance.now();if(this.prevGpsSpeed=this.lastGpsSpeed,this.prevGpsTimestamp=this.lastGpsTimestamp,this.prevGpsTimestamp>0){const a=(i-this.prevGpsTimestamp)/1e3;a>.01&&(this.gpsAcceleration=(t-this.prevGpsSpeed)/a)}this.lastGpsSpeed=t,this.lastGpsTimestamp=i,this.gpsAccuracy=e.coords.accuracy,this.interpolatedSpeed=t,this._isActive&&this.statusCallback?.({state:"active",accuracy:this.gpsAccuracy})}async requestAccelerometerPermission(){const e=DeviceMotionEvent;if(typeof e.requestPermission=="function")try{if(await e.requestPermission()!=="granted")return}catch{return}}startAccelerometer(){this.deviceMotionHandler=e=>{const t=e.acceleration||e.accelerationIncludingGravity;if(!t)return;const i=t.x??0,a=t.y??0,s=Math.sqrt(i*i+a*a),r=this.gpsAcceleration>=0?s:-s;this.accelSmoothed=this.accelSmoothed*(1-z)+r*z,this.hasAccelerometer=!0},window.addEventListener("devicemotion",this.deviceMotionHandler)}}const vr=.15,br=5,wr=8;class Mr{smoothedThrottle=0;smoothedBrake=0;revLimiterPhase=0;prevThrottle=0;turboModel=null;setTurbo(e){this.turboModel=e?new O(e):null}update(e,t,i,a,s,r){const{speedMs:l,accelerationMs2:c}=e,o=c>0?Math.min(1,c/br):0,n=c<0?Math.min(1,-c/wr):0,d=l<.5&&o<.05?.05:o,h=Math.min(1,a/vr);this.smoothedThrottle+=(d-this.smoothedThrottle)*h,this.smoothedBrake+=(n-this.smoothedBrake)*h,i.gear===0&&l>.5&&i.shiftUp(s);const u=i.gear;let m=u>=1?i.speedToRPM(l,u):t.idleRPM;u>=1&&l>0?m=Math.max(t.idleRPM,Math.min(t.redlineRPM,m)):m=J(m,t),r==="automatic"&&i.checkAutoShift(m,this.smoothedThrottle,l,s);const g=Y(m,this.smoothedThrottle,t);let f=0,b=0,R=g;if(this.turboModel&&t.turbo){const M=this.turboModel.update(m,this.smoothedThrottle,a);f=M.boostBar,b=M.bovEnvelope;const v=f/t.turbo.maxBoostBar;R=g*(.65+.35*v)}const w=X(m,t,this.revLimiterPhase,a);this.revLimiterPhase=w.newPhase,R*=w.torqueMultiplier;const{kw:k,hp:S}=F(R,m),B=this.prevThrottle>.7&&this.smoothedThrottle<.2&&m>t.redlineRPM*.6;return this.prevThrottle=this.smoothedThrottle,{engineState:{rpm:m,throttle:this.smoothedThrottle,brake:this.smoothedBrake,gear:u,speedMs:l,speedKmh:l*3.6,accelerationMs2:c,accelerationG:c/9.81,torqueNm:R,powerKw:k,powerHp:S,boostBar:f,isShifting:i.isShifting,transmissionMode:r,revLimiterActive:w.torqueMultiplier<.5,wheelSlip:0,launchControlActive:!1},decelCrackle:B,bovEnvelope:b}}reset(){this.smoothedThrottle=0,this.smoothedBrake=0,this.revLimiterPhase=0,this.prevThrottle=0,this.turboModel&&(this.turboModel=null)}}class Pr{profile;transmission;vehicleDynamics;turboModel=null;audioEngine;dashboard;controls;state;isRunning=!1;lastTimestamp=0;animFrameId=0;revLimiterPhase=0;startupBlipTimer=0;prevThrottle=0;launchControlActive=!1;launchPhaseTimer=0;gallery;sensorProvider;evLoop;inputMode="keyboard";constructor(){this.profile=fr(),this.transmission=new D(this.profile),this.vehicleDynamics=new N(this.profile),this.profile.turbo&&(this.turboModel=new O(this.profile.turbo)),this.audioEngine=new me,this.dashboard=new fe("tachometer-canvas","gauges",this.profile),this.controls=new ge("controls-container"),this.gallery=new Me("profile-selector-container",mr(),this.profile,e=>this.switchProfile(e)),this.sensorProvider=new gr,this.evLoop=new Mr,this.state=this.createInitialState(),this.controls.onVolumeChange(e=>this.audioEngine.setVolume(e)),this.controls.onInputModeChange(e=>this.switchInputMode(e)),this.sensorProvider.onStatusChange(e=>this.controls.setEvStatus(e)),this.controls.onPowerChange(e=>{e?this.engineOn().catch(t=>console.error("Engine start failed",t)):this.engineOff()}),this.controls.setHornClick(()=>this.audioEngine.playHorn()),this.controls.setAudioDebugGetter(()=>this.audioEngine.getDebugInfo()),this.controls.onToneChange(e=>this.audioEngine.setToneOptions(e)),this.audioEngine.setToneOptions({bassDb:12,reverbWet:.33}),this.dashboard.render(this.state),this.controls.updateGearDisplay(0,!1)}async engineOn(){this.isRunning||(await this.audioEngine.initialize(this.profile),await this.audioEngine.start(),await this.audioEngine.playStarterSound(),this.state=this.createInitialState(),this.revLimiterPhase=0,this.startupBlipTimer=.3,this.launchControlActive=!1,this.launchPhaseTimer=0,this.isRunning=!0,this.gallery.setCompact(!0),this.lastTimestamp=performance.now(),this.animFrameId=requestAnimationFrame(e=>this.loop(e)))}engineOff(){this.isRunning=!1,this.gallery.setCompact(!1),cancelAnimationFrame(this.animFrameId),this.state={...this.state,rpm:0,throttle:0,gear:0,speedMs:0,speedKmh:0,accelerationMs2:0,accelerationG:0,torqueNm:0,powerKw:0,powerHp:0,boostBar:0,revLimiterActive:!1,wheelSlip:0,launchControlActive:!1},this.dashboard.render(this.state),this.controls.updateGearDisplay(0,!1),this.audioEngine.stop(),this.vehicleDynamics.reset(),this.transmission.reset(),this.inputMode==="ev-augmented"&&(this.sensorProvider.stop(),this.inputMode="keyboard",this.controls.revertToKeyboard())}async switchInputMode(e){if(e!==this.inputMode)if(e==="ev-augmented"){if((await this.sensorProvider.start()).state==="error"){this.controls.revertToKeyboard();return}this.inputMode="ev-augmented",this.evLoop.reset(),this.evLoop.setTurbo(this.profile.turbo),this.isRunning||this.controls.simulatePowerOn(),this.transmission.gear===0&&this.transmission.shiftUp(performance.now())}else this.sensorProvider.stop(),this.inputMode="keyboard"}loop(e){if(!this.isRunning)return;const t=Math.min((e-this.lastTimestamp)/1e3,.05);this.lastTimestamp=e,this.inputMode==="ev-augmented"?this.loopEvAugmented(t,e):this.loopKeyboard(t,e),this.audioEngine.update(this.state),this.audioEngine.updateTireSqueal(this.state.wheelSlip),this.dashboard.render(this.state),this.controls.updateGearDisplay(this.transmission.gear,this.transmission.isShifting),this.animFrameId=requestAnimationFrame(i=>this.loop(i))}loopEvAugmented(e,t){const i=this.controls.update(e);this.transmission.update(e),this.transmission.mode=i.transmissionMode,i.shiftUpPressed&&(i.transmissionMode==="automatic"&&this.transmission.gear>0?this.transmission.manualOverrideShift("up",t):this.transmission.shiftUp(t)),i.shiftDownPressed&&(i.transmissionMode==="automatic"&&this.transmission.gear>0?this.transmission.manualOverrideShift("down",t):this.transmission.shiftDown(t,this.state.speedMs));const a=this.sensorProvider.update(e),s=this.evLoop.update(a,this.profile,this.transmission,e,t,i.transmissionMode);this.state=s.engineState,s.decelCrackle&&this.audioEngine.triggerDecelCrackle(),s.bovEnvelope>.01&&this.audioEngine.triggerBOV(s.bovEnvelope),this.state.revLimiterActive&&this.audioEngine.triggerRevLimiterPop()}loopKeyboard(e,t){const i=this.controls.update(e);if(this.startupBlipTimer>0){this.startupBlipTimer-=e;const M=Math.max(0,this.startupBlipTimer/.3);i.throttle=Math.max(i.throttle,.3*M)}this.transmission.update(e),this.transmission.mode=i.transmissionMode,i.shiftUpPressed&&(i.transmissionMode==="automatic"&&this.transmission.gear>0?this.transmission.manualOverrideShift("up",t):this.transmission.shiftUp(t)),i.shiftDownPressed&&(i.transmissionMode==="automatic"&&this.transmission.gear>0?this.transmission.manualOverrideShift("down",t):this.transmission.shiftDown(t,this.state.speedMs)),this.transmission.gear===1&&i.brake>.5&&i.throttle>.8&&this.state.speedMs<1?this.launchControlActive=!0:this.launchControlActive&&(i.brake<.1?(this.launchControlActive=!1,this.launchPhaseTimer=1.5):i.throttle<.3&&(this.launchControlActive=!1,this.launchPhaseTimer=0)),this.launchPhaseTimer>0&&(this.launchPhaseTimer=Math.max(0,this.launchPhaseTimer-e)),this.launchControlActive&&i.brake>.3&&this.vehicleDynamics.reset();const s=12,r=this.state.speedMs,l=this.transmission.gear,c=l>=1?this.transmission.speedToRPM(r,l):this.profile.idleRPM;let o=1,n;if(l===0)n=this.state.rpm;else if(this.launchControlActive)n=this.state.rpm,o=0;else if(r<s&&l>=1){const M=r/s;if(o=Math.min(1,M*M),this.launchPhaseTimer>0){const v=.2+.8*(1-this.launchPhaseTimer/1.5);o*=v}i.throttle<.05?(n=this.profile.idleRPM,o=0):(o=Math.max(.35*i.throttle,o),n=(this.profile.idleRPM+i.throttle*(this.profile.redlineRPM-this.profile.idleRPM)*.85)*(1-o)+c*o,n=Math.max(n,this.profile.idleRPM))}else n=Math.max(c,this.profile.idleRPM);const d=Y(n,i.throttle,this.profile);let h=0;if(this.turboModel){const M=this.turboModel.update(n,i.throttle,e);h=M.boostBar,M.bovActive&&this.audioEngine.triggerBOV(M.bovEnvelope)}let u;if(this.profile.turbo&&this.turboModel){const M=h/this.profile.turbo.maxBoostBar;u=d*(.65+.35*M)}else u=d;const m=X(n,this.profile,this.revLimiterPhase,e);this.revLimiterPhase=m.newPhase,u*=m.torqueMultiplier,m.popTriggered&&this.audioEngine.triggerRevLimiterPop();const g=u;o===0&&(u=0);const{speedMs:f,accelerationMs2:b,wheelSlip:R}=this.vehicleDynamics.update(e,u,this.transmission.gear,i.brake,this.transmission.isShifting);let w;const k=this.transmission.speedToRPM(f,this.transmission.gear);if(l===0){let v=i.throttle>.05?this.profile.idleRPM+i.throttle*(this.profile.redlineRPM-this.profile.idleRPM)*1.05:this.profile.idleRPM;this.state.rpm>=this.profile.redlineRPM-100&&m.torqueMultiplier<.1&&(v=Math.min(v,this.profile.redlineRPM-200));const T=v>this.state.rpm?.15:.4;w=this.state.rpm+(v-this.state.rpm)*Math.min(1,e/T)}else if(this.launchControlActive){const M=Math.min(this.profile.peakPowerRPM*.7,this.profile.redlineRPM*.65);w=this.state.rpm+(M-this.state.rpm)*Math.min(1,e/.1)}else if(o<.99&&l>=1&&i.throttle>=.05){const M=f/s;let v=Math.min(1,M*M);if(this.launchPhaseTimer>0){const x=.2+.8*(1-this.launchPhaseTimer/1.5);v*=x}v=Math.max(.35*i.throttle,v),w=(this.profile.idleRPM+i.throttle*(this.profile.redlineRPM-this.profile.idleRPM)*.85)*(1-v)+k*v,w=Math.max(w,this.profile.idleRPM)}else l>=1?w=f<=0?this.profile.idleRPM:k:w=this.profile.idleRPM;l>=1&&f>0&&o>=.99?w=Math.max(0,Math.min(this.profile.redlineRPM,w)):w=J(w,this.profile),i.transmissionMode==="automatic"&&this.transmission.checkAutoShift(w,i.throttle,f,t);const S=this.launchControlActive?g:u,{kw:B,hp:C}=F(S,w);this.state={rpm:w,throttle:i.throttle,brake:i.brake,gear:this.transmission.gear,speedMs:f,speedKmh:f*3.6,accelerationMs2:b,accelerationG:b/9.81,torqueNm:S,powerKw:B,powerHp:C,boostBar:h,isShifting:this.transmission.isShifting,transmissionMode:i.transmissionMode,revLimiterActive:m.torqueMultiplier<.5,wheelSlip:R,launchControlActive:this.launchControlActive},this.prevThrottle>.7&&i.throttle<.2&&w>this.profile.redlineRPM*.6&&this.audioEngine.triggerDecelCrackle(),this.prevThrottle=i.throttle}async switchProfile(e){this.profile=e,this.transmission=new D(e),this.vehicleDynamics=new N(e),this.turboModel=e.turbo?new O(e.turbo):null,this.vehicleDynamics.reset(),this.revLimiterPhase=0,this.launchControlActive=!1,this.launchPhaseTimer=0,this.dashboard.setProfile(e),this.isRunning&&await this.audioEngine.switchProfile(e),this.evLoop.reset(),this.evLoop.setTurbo(e.turbo),this.state=this.createInitialState()}createInitialState(){return{rpm:this.isRunning?this.profile.idleRPM:0,throttle:0,brake:0,gear:0,speedMs:0,speedKmh:0,accelerationMs2:0,accelerationG:0,torqueNm:0,powerKw:0,powerHp:0,boostBar:0,isShifting:!1,transmissionMode:"automatic",revLimiterActive:!1,wheelSlip:0,launchControlActive:!1}}}"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("./sw.js",{scope:"./"}).catch(()=>{})});new Pr;
